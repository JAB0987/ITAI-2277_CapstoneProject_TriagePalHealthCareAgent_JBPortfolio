<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>4fa54a186af84345899e28991261d234</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell markdown" id="oM8W7Dd7nnZT">
<p>We used KaggleHub to download the Conjunctivitis Dataset from Kaggle.
After downloading, we printed the dataset path to confirm that it was
stored correctly. This dataset includes images of both healthy and
infected eyes. We explored the folders to make sure the data was
organized and ready for processing. We imported straight from Kaggle
using the API and used 2 test images for the dataset.</p>
</div>
<div class="cell code" data-execution_count="1"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:3548,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763510832489,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="X7OU3vEKuBkm" data-outputId="59d87969-03b7-488c-e882-6d581443ded3">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Download latest version</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;alisofiya/conjunctivitis&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Path to dataset files:&quot;</span>, path)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Using Colab cache for faster access to the &#39;conjunctivitis&#39; dataset.
Path to dataset files: /kaggle/input/conjunctivitis
</code></pre>
</div>
</div>
<div class="cell markdown" id="Zgg0bLHZuYZf">
<p><strong>Step 1</strong> Install Packages and Imports</p>
</div>
<div class="cell code" data-execution_count="2"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:40936,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763510873428,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="EvvRd0MjuhRY" data-outputId="3e713632-6ccd-4467-e41a-5b37cb9e5c34">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 1 — install &amp; imports</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Install required packages (quiet mode, safe if already installed)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q kagglehub tensorflow matplotlib scikit<span class="op">-</span>learn pandas pillow</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Core imports</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, glob, random</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># TensorFlow / Keras</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator, load_img, img_to_array</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, GlobalAveragePooling2D</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproducibility</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>random.seed(SEED)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>np.random.seed(SEED)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>tf.random.set_seed(SEED)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;TensorFlow version:&quot;</span>, tf.__version__)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>TensorFlow version: 2.19.0
</code></pre>
</div>
</div>
<div class="cell markdown" id="oGJdLmlchH5h">
<p><strong>Step 2 Ensure dataset path is available</strong></p>
<p>This cell checks whether the path exist and downloads if needed. It
then finds image files recursively under that path and infers labels
from parent folders</p>
</div>
<div class="cell code" data-execution_count="3"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:425,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763510873855,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="GQniLSMnhRB2" data-outputId="4a3530eb-6188-4d5a-e800-09e6ef1943bf">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 2 — locate / download dataset and build a DataFrame (image_path, label)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Try to reuse a previously-downloaded path; otherwise download</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    path                     <span class="co"># &lt;-- just check if the variable exists</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Using existing `path` variable:&quot;</span>, path)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;`path` not found — downloading dataset via kagglehub...&quot;</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;alisofiya/conjunctivitis&quot;</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Downloaded dataset to:&quot;</span>, path)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Path object</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>dataset_root <span class="op">=</span> Path(path)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Find **all** image files (jpg + jpeg + png – the dataset contains a few .png)</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> (</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_root.rglob(<span class="st">&quot;*.jpg&quot;</span>)) <span class="op">+</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_root.rglob(<span class="st">&quot;*.jpeg&quot;</span>)) <span class="op">+</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_root.rglob(<span class="st">&quot;*.png&quot;</span>))) <span class="co"># Corrected variable name here</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Using existing `path` variable: /kaggle/input/conjunctivitis
</code></pre>
</div>
</div>
<div class="cell markdown" id="0zRvsLqIhuFi">
<p><strong>Step 3 Quick EDA:</strong></p>
<p>Class counts and sample images shows how many images per class and
some example images.</p>
</div>
<div class="cell code" data-execution_count="4"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:922}"
data-executionInfo="{&quot;elapsed&quot;:1464,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763510875335,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="Og-cHf14h5VP" data-outputId="055a455d-fe39-4e03-9a04-75b39ba4158e">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 3 — EDA: class distribution + sample images</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame from img_files</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> [[<span class="bu">str</span>(p), p.parent.name] <span class="cf">for</span> p <span class="kw">in</span> img_files]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(rows, columns<span class="op">=</span>[<span class="st">&quot;image_path&quot;</span>, <span class="st">&quot;label&quot;</span>])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span>SEED).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> df[<span class="st">&#39;label&#39;</span>].value_counts()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Class distribution:</span><span class="ch">\n</span><span class="st">&quot;</span>, counts)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># bar plot</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">4</span>))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>counts.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Class distribution&quot;</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># show up to 6 sample images (1 per class if multiple)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>unique_labels <span class="op">=</span> df[<span class="st">&#39;label&#39;</span>].unique()</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, lab <span class="kw">in</span> <span class="bu">enumerate</span>(unique_labels[:<span class="dv">6</span>]):</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    sample <span class="op">=</span> df[df[<span class="st">&#39;label&#39;</span>]<span class="op">==</span>lab].iloc[<span class="dv">0</span>][<span class="st">&#39;image_path&#39;</span>]</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(sample).convert(<span class="st">&#39;RGB&#39;</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    plt.subplot(<span class="dv">1</span>, <span class="bu">min</span>(<span class="dv">6</span>, <span class="bu">len</span>(unique_labels)), i<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img.resize((<span class="dv">200</span>,<span class="dv">200</span>)))</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    plt.title(lab)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Class distribution:
 label
healthy_eye     181
infected_eye    177
Name: count, dtype: int64
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_90104e1ddeda421dadaa14afedcc022e/aade320e893e6f649a3ca21317280ea3cdaad363.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_90104e1ddeda421dadaa14afedcc022e/71b2c4509390bbf549368372feac81fbc93190ea.png" /></p>
</div>
</div>
<div class="cell markdown" id="uDi3eNohh_0u">
<p><strong>Step 4 Split into train /val/ test (80/10/10)</strong> We
create splits keeping class balance (stratify)</p>
</div>
<div class="cell code" data-execution_count="5"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:7,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763510875343,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="Zyays8EViRLv" data-outputId="df76800b-51cf-462d-f984-1122e93f36da">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 4 — train/val/test split</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>train_df, temp_df <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span><span class="fl">0.2</span>, stratify<span class="op">=</span>df[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span>SEED)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>val_df, test_df <span class="op">=</span> train_test_split(temp_df, test_size<span class="op">=</span><span class="fl">0.5</span>, stratify<span class="op">=</span>temp_df[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span>SEED)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Counts -&gt; Train:&quot;</span>, <span class="bu">len</span>(train_df), <span class="st">&quot;Val:&quot;</span>, <span class="bu">len</span>(val_df), <span class="st">&quot;Test:&quot;</span>, <span class="bu">len</span>(test_df))</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Counts -&gt; Train: 286 Val: 36 Test: 36
</code></pre>
</div>
</div>
<div class="cell markdown" id="V70-r_ZUmYhB">
<p><strong>Step 5</strong></p>
<p>Create ImageDataGenerators (with simple augmentation for train)</p>
<p>We use flow_from_dataframe with directory=None and x_col containing
full paths.class_mode='binary' if there are exactly 2 labels; otherwise
'categorical' for multi-class. The code auto-detects whether binary or
multi-class.</p>
</div>
<div class="cell code" data-execution_count="6"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:16,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763510875360,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="CKJQyh1zma4Z" data-outputId="64d08687-b247-4213-e2a6-aa47d2ca6ecc">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 5 — prepare generators</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> (<span class="dv">128</span>, <span class="dv">128</span>) <span class="co"># small for fast prototyping</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># determine if binary</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>unique_labels <span class="op">=</span> <span class="bu">sorted</span>(df[<span class="st">&#39;label&#39;</span>].unique())</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>is_binary <span class="op">=</span> (<span class="bu">len</span>(unique_labels) <span class="op">==</span> <span class="dv">2</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Binary classification?&quot;</span> , is_binary, <span class="st">&quot;Labels:&quot;</span>, unique_labels)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># training augmentation</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>train_datagen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>rotation_range<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>width_shift_range<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>height_shift_range<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>zoom_range<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>horizontal_flip<span class="op">=</span><span class="va">True</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># validation &amp; test just rescale</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>test_val_datagen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># flow_from_dataframe expects column names and directory argument. If x_col has full paths use directory=None</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_binary:</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    class_mode <span class="op">=</span> <span class="st">&#39;binary&#39;</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    class_mode <span class="op">=</span> <span class="st">&#39;categorical&#39;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert image_path column to string type</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>train_df[<span class="st">&#39;image_path&#39;</span>] <span class="op">=</span> train_df[<span class="st">&#39;image_path&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>val_df[<span class="st">&#39;image_path&#39;</span>] <span class="op">=</span> val_df[<span class="st">&#39;image_path&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>test_df[<span class="st">&#39;image_path&#39;</span>] <span class="op">=</span> test_df[<span class="st">&#39;image_path&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>train_gen <span class="op">=</span> train_datagen.flow_from_dataframe(</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>train_df,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>target_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>class_mode<span class="op">=</span>class_mode,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>directory<span class="op">=</span><span class="va">None</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>val_gen <span class="op">=</span> test_val_datagen.flow_from_dataframe(</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>val_df,</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>target_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>class_mode<span class="op">=</span>class_mode,</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>directory<span class="op">=</span><span class="va">None</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>test_gen <span class="op">=</span> test_val_datagen.flow_from_dataframe(</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>test_df,</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>target_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>batch_size<span class="op">=</span>BATCH_SIZE,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>class_mode<span class="op">=</span>class_mode,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>shuffle<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>directory<span class="op">=</span><span class="va">None</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>label2index <span class="op">=</span> train_gen.class_indices</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>index2label <span class="op">=</span> {v:k <span class="cf">for</span> k,v <span class="kw">in</span> label2index.items()}</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Label mapping (label -&gt; index):&quot;</span>, label2index)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Binary classification? True Labels: [&#39;healthy_eye&#39;, &#39;infected_eye&#39;]
Found 286 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
Found 36 validated image filenames belonging to 2 classes.
Label mapping (label -&gt; index): {&#39;healthy_eye&#39;: 0, &#39;infected_eye&#39;: 1}
</code></pre>
</div>
</div>
<div class="cell markdown" id="C3aLVxk5mxuR">
<p><strong>Step 6</strong></p>
<p>Build a small CNN (fast to run) A compact architecture suitable for 5
epochs prototype. We ran different tests on the epochs to try to get
more accuracy the more you run I feel the more accurate it becomes
although sometimes it can become pretty time consuming depending on the
dataset, but since this is a simple dataset it didn't take to long.</p>
</div>
<div class="cell code" data-execution_count="7"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:650}"
data-executionInfo="{&quot;elapsed&quot;:404,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763510875765,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="5-6WIySimxA7" data-outputId="91939d92-e083-4b98-9ff4-2427b3e35187">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 6 — build model</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> BatchNormalization, Dropout, Dense  <span class="co"># &lt;-- Add Dense here</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="bu">len</span>(unique_labels)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_binary:</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    output_units <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    output_activation <span class="op">=</span> <span class="st">&#39;sigmoid&#39;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="st">&#39;binary_crossentropy&#39;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    output_units <span class="op">=</span> num_classes</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    output_activation <span class="op">=</span> <span class="st">&#39;softmax&#39;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="st">&#39;categorical_crossentropy&#39;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">32</span>, (<span class="dv">3</span>,<span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, input_shape<span class="op">=</span>(IMG_SIZE[<span class="dv">0</span>], IMG_SIZE[<span class="dv">1</span>], <span class="dv">3</span>)),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    BatchNormalization(),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">64</span>, (<span class="dv">3</span>,<span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    BatchNormalization(),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">128</span>, (<span class="dv">3</span>,<span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D(<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    GlobalAveragePooling2D(),</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    Dropout(<span class="fl">0.35</span>),</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    Dense(output_units, activation<span class="op">=</span>output_activation)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span><span class="fl">1e-3</span>),</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    loss<span class="op">=</span>loss,</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>]</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
</code></pre>
</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Model: "sequential"</span>
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃<span style="font-weight: bold"> Layer (type)                    </span>┃<span style="font-weight: bold"> Output Shape           </span>┃<span style="font-weight: bold">       Param # </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ conv2d (<span style="color: #0087ff; text-decoration-color: #0087ff">Conv2D</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">126</span>, <span style="color: #00af00; text-decoration-color: #00af00">126</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)   │           <span style="color: #00af00; text-decoration-color: #00af00">896</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ max_pooling2d (<span style="color: #0087ff; text-decoration-color: #0087ff">MaxPooling2D</span>)    │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)     │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ batch_normalization             │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">63</span>, <span style="color: #00af00; text-decoration-color: #00af00">32</span>)     │           <span style="color: #00af00; text-decoration-color: #00af00">128</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">BatchNormalization</span>)            │                        │               │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ conv2d_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Conv2D</span>)               │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">61</span>, <span style="color: #00af00; text-decoration-color: #00af00">61</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)     │        <span style="color: #00af00; text-decoration-color: #00af00">18,496</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ max_pooling2d_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">MaxPooling2D</span>)  │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)     │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ batch_normalization_1           │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">30</span>, <span style="color: #00af00; text-decoration-color: #00af00">64</span>)     │           <span style="color: #00af00; text-decoration-color: #00af00">256</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">BatchNormalization</span>)            │                        │               │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ conv2d_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">Conv2D</span>)               │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">28</span>, <span style="color: #00af00; text-decoration-color: #00af00">28</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)    │        <span style="color: #00af00; text-decoration-color: #00af00">73,856</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ max_pooling2d_2 (<span style="color: #0087ff; text-decoration-color: #0087ff">MaxPooling2D</span>)  │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">14</span>, <span style="color: #00af00; text-decoration-color: #00af00">14</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)    │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ global_average_pooling2d        │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)            │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
│ (<span style="color: #0087ff; text-decoration-color: #0087ff">GlobalAveragePooling2D</span>)        │                        │               │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                   │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)            │        <span style="color: #00af00; text-decoration-color: #00af00">16,512</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (<span style="color: #0087ff; text-decoration-color: #0087ff">Dropout</span>)               │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">128</span>)            │             <span style="color: #00af00; text-decoration-color: #00af00">0</span> │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense_1 (<span style="color: #0087ff; text-decoration-color: #0087ff">Dense</span>)                 │ (<span style="color: #00d7ff; text-decoration-color: #00d7ff">None</span>, <span style="color: #00af00; text-decoration-color: #00af00">1</span>)              │           <span style="color: #00af00; text-decoration-color: #00af00">129</span> │
└─────────────────────────────────┴────────────────────────┴───────────────┘
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Total params: </span><span style="color: #00af00; text-decoration-color: #00af00">110,273</span> (430.75 KB)
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">110,081</span> (430.00 KB)
</pre>

</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold"> Non-trainable params: </span><span style="color: #00af00; text-decoration-color: #00af00">192</span> (768.00 B)
</pre>

</div>
</div>
<div class="cell markdown" id="GD80ToSYnwOF">
<p><strong>step 7</strong></p>
<p>Train for 5-20 epochs Train quickly for your prototype. Save training
history. Also compare results from the different numbers ran.</p>
</div>
<div class="cell code" data-execution_count="8"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:455962,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511331730,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="j2hzwP9ln45L" data-outputId="c21c3ca3-29b0-47e5-8c0b-0aa0de747350">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 7 — train</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>train_gen,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>validation_data<span class="op">=</span>val_gen,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>epochs<span class="op">=</span>EPOCHS</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Epoch 1/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 30s 1s/step - accuracy: 0.6789 - loss: 0.6007 - val_accuracy: 0.5000 - val_loss: 0.6905
Epoch 2/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 36s 1s/step - accuracy: 0.8117 - loss: 0.3955 - val_accuracy: 0.5000 - val_loss: 0.6877
Epoch 3/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 18s 929ms/step - accuracy: 0.8282 - loss: 0.3537 - val_accuracy: 0.5000 - val_loss: 0.6908
Epoch 4/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 661ms/step - accuracy: 0.8067 - loss: 0.4218 - val_accuracy: 0.5000 - val_loss: 0.6938
Epoch 5/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 21s 669ms/step - accuracy: 0.8273 - loss: 0.3547 - val_accuracy: 0.5000 - val_loss: 0.7083
Epoch 6/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 664ms/step - accuracy: 0.7637 - loss: 0.4799 - val_accuracy: 0.5000 - val_loss: 0.7703
Epoch 7/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 11s 618ms/step - accuracy: 0.7928 - loss: 0.4384 - val_accuracy: 0.5000 - val_loss: 0.7790
Epoch 8/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 21s 653ms/step - accuracy: 0.8324 - loss: 0.3659 - val_accuracy: 0.5000 - val_loss: 0.8986
Epoch 9/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 653ms/step - accuracy: 0.8493 - loss: 0.3423 - val_accuracy: 0.5000 - val_loss: 1.0070
Epoch 10/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 15s 859ms/step - accuracy: 0.8848 - loss: 0.2640 - val_accuracy: 0.5000 - val_loss: 1.1598
Epoch 11/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 665ms/step - accuracy: 0.8560 - loss: 0.3115 - val_accuracy: 0.5000 - val_loss: 1.0424
Epoch 12/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 20s 662ms/step - accuracy: 0.8379 - loss: 0.3051 - val_accuracy: 0.5000 - val_loss: 1.3722
Epoch 13/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 648ms/step - accuracy: 0.8536 - loss: 0.2886 - val_accuracy: 0.5000 - val_loss: 0.8961
Epoch 14/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 11s 627ms/step - accuracy: 0.8853 - loss: 0.3071 - val_accuracy: 0.5000 - val_loss: 0.9579
Epoch 15/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 11s 567ms/step - accuracy: 0.8928 - loss: 0.2440 - val_accuracy: 0.5000 - val_loss: 1.3621
Epoch 16/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 619ms/step - accuracy: 0.8533 - loss: 0.3085 - val_accuracy: 0.5000 - val_loss: 1.1853
Epoch 17/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 651ms/step - accuracy: 0.8606 - loss: 0.2739 - val_accuracy: 0.5000 - val_loss: 1.4214
Epoch 18/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 15s 855ms/step - accuracy: 0.9356 - loss: 0.2042 - val_accuracy: 0.5000 - val_loss: 1.0606
Epoch 19/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 15s 695ms/step - accuracy: 0.9154 - loss: 0.2435 - val_accuracy: 0.5000 - val_loss: 0.9956
Epoch 20/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 606ms/step - accuracy: 0.8794 - loss: 0.2743 - val_accuracy: 0.4722 - val_loss: 0.8961
Epoch 21/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 21s 667ms/step - accuracy: 0.9313 - loss: 0.1674 - val_accuracy: 0.5000 - val_loss: 1.3437
Epoch 22/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 20s 638ms/step - accuracy: 0.9440 - loss: 0.1538 - val_accuracy: 0.5000 - val_loss: 2.2401
Epoch 23/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 644ms/step - accuracy: 0.9510 - loss: 0.1544 - val_accuracy: 0.5000 - val_loss: 1.3507
Epoch 24/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 11s 607ms/step - accuracy: 0.9262 - loss: 0.2115 - val_accuracy: 0.5000 - val_loss: 1.5631
Epoch 25/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 11s 590ms/step - accuracy: 0.9257 - loss: 0.1713 - val_accuracy: 0.4722 - val_loss: 1.5957
Epoch 26/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 642ms/step - accuracy: 0.9257 - loss: 0.2019 - val_accuracy: 0.5000 - val_loss: 2.1964
Epoch 27/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 670ms/step - accuracy: 0.9168 - loss: 0.1775 - val_accuracy: 0.5000 - val_loss: 0.8494
Epoch 28/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 658ms/step - accuracy: 0.9439 - loss: 0.1940 - val_accuracy: 0.8056 - val_loss: 0.4436
Epoch 29/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 668ms/step - accuracy: 0.8890 - loss: 0.2207 - val_accuracy: 0.7222 - val_loss: 0.5475
Epoch 30/30
18/18 ━━━━━━━━━━━━━━━━━━━━ 12s 650ms/step - accuracy: 0.8688 - loss: 0.3204 - val_accuracy: 0.8611 - val_loss: 0.3763
</code></pre>
</div>
</div>
<div class="cell markdown" id="Wg1TnpjXoFmj">
<p><strong>step 8</strong></p>
<p>Evaluate on test set; show metrics &amp; confusion matrix We compute
predictions and show classification report and confusion matrix.</p>
</div>
<div class="cell code" data-execution_count="9"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:685}"
data-executionInfo="{&quot;elapsed&quot;:1853,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511333585,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="3vVU1CuCoIpQ" data-outputId="763e5f84-c09b-41af-c3d9-715bcf0fa961">
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 8 — evaluate and metrics</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate with generator</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>test_loss, test_acc <span class="op">=</span> model.evaluate(test_gen, verbose<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Test loss: </span><span class="sc">{</span>test_loss<span class="sc">:.4f}</span><span class="ss">, Test accuracy: </span><span class="sc">{</span>test_acc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict probabilities for entire test set</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>y_probs <span class="op">=</span> model.predict(test_gen)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> is_binary:</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y_probs shape is (N, 1) → flatten and threshold at 0.5</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> (y_probs.ravel() <span class="op">&gt;</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For multi-class: take argmax</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_probs, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co"># True labels from test_df (map labels to indices using label2index)</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> test_df[<span class="st">&#39;label&#39;</span>].<span class="bu">map</span>(label2index).values</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Classification report</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Classification report:&quot;</span>)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_true, y_pred, target_names<span class="op">=</span><span class="bu">list</span>(label2index.keys())))</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion matrix</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Confusion matrix:</span><span class="ch">\n</span><span class="st">&quot;</span>, cm)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot confusion matrix</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">4</span>))</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>plt.imshow(cm, interpolation<span class="op">=</span><span class="st">&#39;nearest&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Blues&#39;</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Confusion Matrix&quot;</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>plt.colorbar()</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Set ticks and labels correctly</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>tick_labels <span class="op">=</span> [index2label[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(label2index))]</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>plt.xticks(ticks<span class="op">=</span>np.arange(<span class="bu">len</span>(label2index)), labels<span class="op">=</span>tick_labels, rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>plt.yticks(ticks<span class="op">=</span>np.arange(<span class="bu">len</span>(label2index)), labels<span class="op">=</span>tick_labels)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;True label&#39;</span>)</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Predicted label&#39;</span>)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()  <span class="co"># Prevents label cutoff</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>3/3 ━━━━━━━━━━━━━━━━━━━━ 0s 99ms/step - accuracy: 0.7917 - loss: 0.4108 
Test loss: 0.3729, Test accuracy: 0.8333
3/3 ━━━━━━━━━━━━━━━━━━━━ 1s 138ms/step
Classification report:
              precision    recall  f1-score   support

 healthy_eye       0.93      0.72      0.81        18
infected_eye       0.77      0.94      0.85        18

    accuracy                           0.83        36
   macro avg       0.85      0.83      0.83        36
weighted avg       0.85      0.83      0.83        36

Confusion matrix:
 [[13  5]
 [ 1 17]]
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_90104e1ddeda421dadaa14afedcc022e/a389ff5857ef4f088d9fabaf32c2086b25fbe7fc.png" /></p>
</div>
</div>
<div class="cell markdown" id="6KzzmvA_oe0D">
<p><strong>Step 9</strong></p>
<p>Predict on our two sample images at /content/Eye Images/... This uses
the same preprocessing (resize &amp; rescale). It prints predicted label
+ confidence and displays the image.</p>
</div>
<div class="cell code" data-execution_count="10"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:14,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511333600,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="-9zHzLnvoocP" data-outputId="2ccaa15f-f500-4b97-ef74-a5919f9b22f1">
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cell 9 — predict on your sample test images</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> load_img, img_to_array</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define IMG_SIZE here to ensure it&#39;s available</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> (<span class="dv">128</span>, <span class="dv">128</span>) <span class="co"># This should match the size used for training</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Update these paths to your actual uploaded images</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure these are paths to image files, not directories</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>sample_paths <span class="op">=</span> [</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/healthy_eye/REPLACE_WITH_YOUR_HEALTHY_EYE_IMAGE.jpg&quot;</span>, <span class="co"># Replace with the path to your healthy eye image</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;/content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/infected_eye/REPLACE_WITH_YOUR_INFECTED_EYE_IMAGE.jpg&quot;</span> <span class="co"># Replace with the path to your infected eye image</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_and_show(img_path):</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(img_path):</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;File not found:&quot;</span>, img_path)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and preprocess image</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> load_img(img_path, target_size<span class="op">=</span>IMG_SIZE)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    arr <span class="op">=</span> img_to_array(img) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    arr <span class="op">=</span> np.expand_dims(arr, axis<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Add batch dimension</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    probs <span class="op">=</span> model.predict(arr)[<span class="dv">0</span>]  <span class="co"># Shape: (1,) for binary, (n_classes,) for multi</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_binary:</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>        prob <span class="op">=</span> <span class="bu">float</span>(probs[<span class="dv">0</span>])</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        pred_idx <span class="op">=</span> <span class="bu">int</span>(prob <span class="op">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> index2label[pred_idx]</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        conf <span class="op">=</span> prob <span class="cf">if</span> pred_idx <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span> <span class="op">-</span> prob</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        pred_idx <span class="op">=</span> <span class="bu">int</span>(np.argmax(probs))</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> index2label[pred_idx]</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>        conf <span class="op">=</span> <span class="bu">float</span>(np.<span class="bu">max</span>(probs))</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print result</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Prediction for </span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(img_path)<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> (confidence: </span><span class="sc">{</span>conf<span class="sc">:.3f}</span><span class="ss">)&quot;</span>)</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show image with prediction</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img)</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f&quot;</span><span class="sc">{</span>label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Confidence: </span><span class="sc">{</span>conf<span class="sc">:.3f}</span><span class="ss">&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Run predictions</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> sample_paths:</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    predict_and_show(p)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>File not found: /content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/healthy_eye/REPLACE_WITH_YOUR_HEALTHY_EYE_IMAGE.jpg
File not found: /content/drive/MyDrive/ITAI 2277 Fall 2025 Capstone /AI Agent Project_ITAI2277/infected_eye/REPLACE_WITH_YOUR_INFECTED_EYE_IMAGE.jpg
</code></pre>
</div>
</div>
<div class="cell markdown" id="_f8DMYUsp1yo">
<p>###Kaggle API</p>
</div>
<div class="cell code" data-execution_count="11"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:73}"
data-executionInfo="{&quot;elapsed&quot;:74068,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511407669,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="E22B71MTRn6-" data-outputId="d60bc6fb-deb6-416b-a557-12421e0bc61e">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaggle API json file upload</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> files</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>uploaded <span class="op">=</span> files.upload()  <span class="co"># Upload your kaggle.json</span></span></code></pre></div>
<div class="output display_data">

     <input type="file" id="files-1126adf8-e7f4-4ada-8fc0-6f82e08fa196" name="files[]" multiple disabled
        style="border:none" />
     <output id="result-1126adf8-e7f4-4ada-8fc0-6f82e08fa196">
      Upload widget is only available when the cell has been executed in the
      current browser session. Please rerun this cell to enable.
      </output>
      <script>// Copyright 2017 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Helpers for google.colab Python module.
 */
(function(scope) {
function span(text, styleAttributes = {}) {
  const element = document.createElement('span');
  element.textContent = text;
  for (const key of Object.keys(styleAttributes)) {
    element.style[key] = styleAttributes[key];
  }
  return element;
}

// Max number of bytes which will be uploaded at a time.
const MAX_PAYLOAD_SIZE = 100 * 1024;

function _uploadFiles(inputId, outputId) {
  const steps = uploadFilesStep(inputId, outputId);
  const outputElement = document.getElementById(outputId);
  // Cache steps on the outputElement to make it available for the next call
  // to uploadFilesContinue from Python.
  outputElement.steps = steps;

  return _uploadFilesContinue(outputId);
}

// This is roughly an async generator (not supported in the browser yet),
// where there are multiple asynchronous steps and the Python side is going
// to poll for completion of each step.
// This uses a Promise to block the python side on completion of each step,
// then passes the result of the previous step as the input to the next step.
function _uploadFilesContinue(outputId) {
  const outputElement = document.getElementById(outputId);
  const steps = outputElement.steps;

  const next = steps.next(outputElement.lastPromiseValue);
  return Promise.resolve(next.value.promise).then((value) => {
    // Cache the last promise value to make it available to the next
    // step of the generator.
    outputElement.lastPromiseValue = value;
    return next.value.response;
  });
}

/**
 * Generator function which is called between each async step of the upload
 * process.
 * @param {string} inputId Element ID of the input file picker element.
 * @param {string} outputId Element ID of the output display.
 * @return {!Iterable<!Object>} Iterable of next steps.
 */
function* uploadFilesStep(inputId, outputId) {
  const inputElement = document.getElementById(inputId);
  inputElement.disabled = false;

  const outputElement = document.getElementById(outputId);
  outputElement.innerHTML = '';

  const pickedPromise = new Promise((resolve) => {
    inputElement.addEventListener('change', (e) => {
      resolve(e.target.files);
    });
  });

  const cancel = document.createElement('button');
  inputElement.parentElement.appendChild(cancel);
  cancel.textContent = 'Cancel upload';
  const cancelPromise = new Promise((resolve) => {
    cancel.onclick = () => {
      resolve(null);
    };
  });

  // Wait for the user to pick the files.
  const files = yield {
    promise: Promise.race([pickedPromise, cancelPromise]),
    response: {
      action: 'starting',
    }
  };

  cancel.remove();

  // Disable the input element since further picks are not allowed.
  inputElement.disabled = true;

  if (!files) {
    return {
      response: {
        action: 'complete',
      }
    };
  }

  for (const file of files) {
    const li = document.createElement('li');
    li.append(span(file.name, {fontWeight: 'bold'}));
    li.append(span(
        `(${file.type || 'n/a'}) - ${file.size} bytes, ` +
        `last modified: ${
            file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() :
                                    'n/a'} - `));
    const percent = span('0% done');
    li.appendChild(percent);

    outputElement.appendChild(li);

    const fileDataPromise = new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve(e.target.result);
      };
      reader.readAsArrayBuffer(file);
    });
    // Wait for the data to be ready.
    let fileData = yield {
      promise: fileDataPromise,
      response: {
        action: 'continue',
      }
    };

    // Use a chunked sending to avoid message size limits. See b/62115660.
    let position = 0;
    do {
      const length = Math.min(fileData.byteLength - position, MAX_PAYLOAD_SIZE);
      const chunk = new Uint8Array(fileData, position, length);
      position += length;

      const base64 = btoa(String.fromCharCode.apply(null, chunk));
      yield {
        response: {
          action: 'append',
          file: file.name,
          data: base64,
        },
      };

      let percentDone = fileData.byteLength === 0 ?
          100 :
          Math.round((position / fileData.byteLength) * 100);
      percent.textContent = `${percentDone}% done`;

    } while (position < fileData.byteLength);
  }

  // All done.
  yield {
    response: {
      action: 'complete',
    }
  };
}

scope.google = scope.google || {};
scope.google.colab = scope.google.colab || {};
scope.google.colab._files = {
  _uploadFiles,
  _uploadFilesContinue,
};
})(self);
</script> 
</div>
<div class="output stream stdout">
<pre><code>Saving kaggle (1).json to kaggle (1).json
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="12"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:1156,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511408827,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="5qmdxYxERqAj" data-outputId="5fa7e29a-9354-4507-e71b-bc67d95b79ea">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#import</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p <span class="op">~/</span>.kaggle</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>cp <span class="st">&quot;/content/kaggle(2).json&quot;</span> <span class="op">~/</span>.kaggle<span class="op">/</span>kaggle.json  <span class="co"># Added quotes around the filename</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>chmod <span class="dv">600</span> <span class="op">~/</span>.kaggle<span class="op">/</span>kaggle.json</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets <span class="bu">list</span> <span class="op">-</span>s conjunctivitis <span class="co"># Search for &quot;conjunctivitis&quot; to confirm datasets loaded</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>cp: cannot stat &#39;/content/kaggle(2).json&#39;: No such file or directory
chmod: cannot access &#39;/root/.kaggle/kaggle.json&#39;: No such file or directory
Traceback (most recent call last):
  File &quot;/usr/local/bin/kaggle&quot;, line 4, in &lt;module&gt;
    from kaggle.cli import main
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/__init__.py&quot;, line 6, in &lt;module&gt;
    api.authenticate()
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/api/kaggle_api_extended.py&quot;, line 434, in authenticate
    raise IOError(&#39;Could not find {}. Make sure it\&#39;s located in&#39;
OSError: Could not find kaggle.json. Make sure it&#39;s located in /root/.kaggle. Or use the environment method. See setup instructions at https://github.com/Kaggle/kaggle-api/
</code></pre>
</div>
</div>
<div class="cell markdown" id="FUW8pJRoqMR_">
<p>###Download Datasets</p>
</div>
<div class="cell code" data-execution_count="13"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:1946,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511410774,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="IQDe1IZ7RteK" data-outputId="88e887c0-0fc5-4aa8-bd4a-2945eeab1d6c">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Eyes (already working via kagglehub)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>eyes_path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;alisofiya/conjunctivitis&quot;</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Eyes:&quot;</span>, eyes_path)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Rashes: Fitzpatrick17k</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets download <span class="op">-</span>d nazmussadat013<span class="op">/</span>fitzpatrick17k <span class="op">-</span>p <span class="op">/</span>content<span class="op">/</span>rashes <span class="op">--</span>unzip</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Wounds</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>kaggle datasets download <span class="op">-</span>d ibrahimfateen<span class="op">/</span>wound<span class="op">-</span>classification <span class="op">-</span>p <span class="op">/</span>content<span class="op">/</span>wounds <span class="op">--</span>unzip</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Using Colab cache for faster access to the &#39;conjunctivitis&#39; dataset.
Eyes: /kaggle/input/conjunctivitis
Traceback (most recent call last):
  File &quot;/usr/local/bin/kaggle&quot;, line 10, in &lt;module&gt;
    sys.exit(main())
             ^^^^^^
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/cli.py&quot;, line 68, in main
    out = args.func(**command_args)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/api/kaggle_api_extended.py&quot;, line 1741, in dataset_download_cli
    with self.build_kaggle_client() as kaggle:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/api/kaggle_api_extended.py&quot;, line 688, in build_kaggle_client
    username=self.config_values[&#39;username&#39;],
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: &#39;username&#39;
Traceback (most recent call last):
  File &quot;/usr/local/bin/kaggle&quot;, line 10, in &lt;module&gt;
    sys.exit(main())
             ^^^^^^
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/cli.py&quot;, line 68, in main
    out = args.func(**command_args)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/api/kaggle_api_extended.py&quot;, line 1741, in dataset_download_cli
    with self.build_kaggle_client() as kaggle:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/dist-packages/kaggle/api/kaggle_api_extended.py&quot;, line 688, in build_kaggle_client
    username=self.config_values[&#39;username&#39;],
             ~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: &#39;username&#39;
</code></pre>
</div>
</div>
<section id="step-4-build-unified-data-prep-function"
class="cell markdown" id="gsZ8zjstqWal">
<h3>Step 4: Build Unified Data Prep Function</h3>
</section>
<div class="cell code" data-execution_count="14"
data-executionInfo="{&quot;elapsed&quot;:22,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511410797,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="J_59q2o1R59T">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_dataset(root_path, img_size<span class="op">=</span>(<span class="dv">224</span>,<span class="dv">224</span>), batch_size<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find images</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    img_files <span class="op">=</span> <span class="bu">list</span>(Path(root_path).rglob(<span class="st">&quot;*.jpg&quot;</span>)) <span class="op">+</span> <span class="bu">list</span>(Path(root_path).rglob(<span class="st">&quot;*.jpeg&quot;</span>))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> [[<span class="bu">str</span>(p), p.parent.name] <span class="cf">for</span> p <span class="kw">in</span> img_files]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(rows, columns<span class="op">=</span>[<span class="st">&quot;image_path&quot;</span>, <span class="st">&quot;label&quot;</span>])</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">42</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    train_df, temp <span class="op">=</span> train_test_split(df, test_size<span class="op">=</span><span class="fl">0.3</span>, stratify<span class="op">=</span>df[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    val_df, test_df <span class="op">=</span> train_test_split(temp, test_size<span class="op">=</span><span class="fl">0.5</span>, stratify<span class="op">=</span>temp[<span class="st">&#39;label&#39;</span>], random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generators</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    train_gen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        rotation_range<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        width_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        height_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        horizontal_flip<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        fill_mode<span class="op">=</span><span class="st">&#39;nearest&#39;</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    ).flow_from_dataframe(train_df, x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>, y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>                          target_size<span class="op">=</span>img_size, batch_size<span class="op">=</span>batch_size,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>                          class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>) <span class="co"># Changed to &#39;categorical&#39;</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    val_gen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>).flow_from_dataframe(</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        val_df,</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        target_size<span class="op">=</span>img_size,</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span> <span class="co"># Changed to &#39;categorical&#39;</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    test_gen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>).flow_from_dataframe(</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        test_df,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>        x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>        target_size<span class="op">=</span>img_size,</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size,</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>        class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span> <span class="co"># Changed to &#39;categorical&#39;</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train_gen, val_gen, test_gen, df</span></code></pre></div>
</div>
<div class="cell markdown" id="FOWkUOTzq2SQ">
<p>###Step 5: Train 3 Models (MobileNetV2)</p>
</div>
<div class="cell code" data-execution_count="15"
data-executionInfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511410798,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="2s-HYvOVR7p2">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications <span class="im">import</span> MobileNetV2</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> GlobalAveragePooling2D, Dense, Dropout</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_model(num_classes):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    base <span class="op">=</span> MobileNetV2(weights<span class="op">=</span><span class="st">&#39;imagenet&#39;</span>, include_top<span class="op">=</span><span class="va">False</span>, input_shape<span class="op">=</span>(<span class="dv">224</span>,<span class="dv">224</span>,<span class="dv">3</span>))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    base.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        base,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        GlobalAveragePooling2D(),</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        Dropout(<span class="fl">0.3</span>),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span> <span class="cf">if</span> num_classes <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">&#39;sigmoid&#39;</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(Adam(<span class="fl">1e-3</span>), loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span> <span class="cf">if</span> num_classes <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">&#39;binary_crossentropy&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div>
</div>
<div class="cell markdown" id="mFz8ZYiyqiCR">
<p>###Create moblenetv2 Diagram</p>
</div>
<div class="cell code" data-execution_count="16"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1000}"
data-executionInfo="{&quot;elapsed&quot;:1735,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511412536,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="x7oEHyyVR-c-" data-outputId="8a4d1c73-3ad4-48df-f22c-3f452b6c16d8">
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.utils <span class="im">import</span> plot_model</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Build your model (use the improved version from my last message)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> build_model(num_classes<span class="op">=</span><span class="dv">2</span>)  <span class="co"># or your final model</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Save diagram</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>plot_model(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    to_file<span class="op">=</span><span class="st">&#39;architecture.png&#39;</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    show_shapes<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    show_layer_names<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    rankdir<span class="op">=</span><span class="st">&#39;TB&#39;</span>,  <span class="co"># Top to Bottom</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    dpi<span class="op">=</span><span class="dv">150</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/mobilenet_v2/mobilenet_v2_weights_tf_dim_ordering_tf_kernels_1.0_224_no_top.h5
9406464/9406464 ━━━━━━━━━━━━━━━━━━━━ 0s 0us/step
</code></pre>
</div>
<div class="output execute_result" data-execution_count="16">
<p><img
src="vertopal_90104e1ddeda421dadaa14afedcc022e/733490e096ceae279e497e1f343e54e98335bc17.png" /></p>
</div>
</div>
<div class="cell code" data-execution_count="17"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:17}"
data-executionInfo="{&quot;elapsed&quot;:35,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511412575,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="XHnx5n09XptJ" data-outputId="00657347-e6d4-4c34-8821-2702ca4260e6">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> files</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>files.download(<span class="st">&#39;architecture.png&#39;</span>)</span></code></pre></div>
<div class="output display_data">
<pre><code>&lt;IPython.core.display.Javascript object&gt;</code></pre>
</div>
<div class="output display_data">
<pre><code>&lt;IPython.core.display.Javascript object&gt;</code></pre>
</div>
</div>
<section id="model-architecture-design" class="cell markdown"
id="EkAnR5a8YObm">
<h1>Model Architecture Design</h1>
<blockquote>
<p><strong>Project</strong>: Conjunctivitis Eye Disease
Classification<br />
<strong>Phase</strong>: 3 (Model Development)<br />
<strong>Date</strong>: October 28, 2025<br />
<strong>Author</strong>: [Your Name]</p>
</blockquote>
<hr />
<h2 id="1-overview">1. Overview</h2>
<p>We designed a <strong>lightweight convolutional neural network
(CNN)</strong> suitable for binary classification of eye images into
<strong>Healthy</strong> and <strong>Infected (Conjunctivitis)</strong>.
The architecture balances performance and training speed on modest
hardware (Colab T4 GPU).</p>
<hr />
<h2 id="2-input-specifications">2. Input Specifications</h2>
<table>
<colgroup>
<col style="width: 53%" />
<col style="width: 46%" />
</colgroup>
<thead>
<tr class="header">
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Input shape</td>
<td><code>(224, 224, 3)</code></td>
</tr>
<tr class="even">
<td>Preprocessing</td>
<td>Rescale <code>/255</code>, data augmentation (rotation, zoom,
flip)</td>
</tr>
<tr class="odd">
<td>Classes</td>
<td>2 (<code>healthy_eye</code>, <code>infected_eye</code>)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-architecture-diagram">3. Architecture Diagram</h2>
<p><img src="figures/architecture.png" alt="Model Architecture" /></p>
<hr />
<h2 id="4-layer-by-layer-specification">4. Layer-by-Layer
Specification</h2>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 25%" />
<col style="width: 18%" />
<col style="width: 21%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="header">
<th>Layer</th>
<th>Type</th>
<th>Output Shape</th>
<th># Params</th>
<th>Activation</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>Input</td>
<td><code>(224, 224, 3)</code></td>
<td>0</td>
<td>–</td>
<td>RGB eye image</td>
</tr>
<tr class="even">
<td>1</td>
<td>Conv2D</td>
<td><code>(222, 222, 32)</code></td>
<td>896</td>
<td>ReLU</td>
<td>3×3 kernel</td>
</tr>
<tr class="odd">
<td>2</td>
<td>BatchNormalization</td>
<td><code>(222, 222, 32)</code></td>
<td>128</td>
<td>–</td>
<td>Stabilizes training</td>
</tr>
<tr class="even">
<td>3</td>
<td>MaxPooling2D</td>
<td><code>(111, 111, 32)</code></td>
<td>0</td>
<td>–</td>
<td>2×2 pool</td>
</tr>
<tr class="odd">
<td>4</td>
<td>Conv2D</td>
<td><code>(109, 109, 64)</code></td>
<td>18,496</td>
<td>ReLU</td>
<td>3×3 kernel</td>
</tr>
<tr class="even">
<td>5</td>
<td>BatchNormalization</td>
<td><code>(109, 109, 64)</code></td>
<td>256</td>
<td>–</td>
<td></td>
</tr>
<tr class="odd">
<td>6</td>
<td>MaxPooling2D</td>
<td><code>(54, 54, 64)</code></td>
<td>0</td>
<td>–</td>
<td></td>
</tr>
<tr class="even">
<td>7</td>
<td>Conv2D</td>
<td><code>(52, 52, 128)</code></td>
<td>73,856</td>
<td>ReLU</td>
<td>3×3 kernel</td>
</tr>
<tr class="odd">
<td>8</td>
<td>BatchNormalization</td>
<td><code>(52, 52, 128)</code></td>
<td>512</td>
<td>–</td>
<td></td>
</tr>
<tr class="even">
<td>9</td>
<td>GlobalAveragePooling2D</td>
<td><code>(128,)</code></td>
<td>0</td>
<td>–</td>
<td>Reduces params</td>
</tr>
<tr class="odd">
<td>10</td>
<td>Dense</td>
<td><code>(2,)</code></td>
<td>258</td>
<td>Softmax</td>
<td>Final classification</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Total trainable parameters</strong>:
<strong>~94K</strong><br />
<strong>Non-trainable</strong>: ~1K (BatchNorm)</p>
</blockquote>
<hr />
<h2 id="5-design-rationale">5. Design Rationale</h2>
<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th>Decision</th>
<th>Reason</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>224×224 input</strong></td>
<td>Standard for medical imaging; captures fine details (vs
128×128)</td>
</tr>
<tr class="even">
<td><strong>3 Conv blocks</strong></td>
<td>Progressive feature extraction without overfitting on small
dataset</td>
</tr>
<tr class="odd">
<td><strong>BatchNormalization</strong></td>
<td>Faster convergence, reduces internal covariate shift</td>
</tr>
<tr class="even">
<td><strong>GlobalAveragePooling</strong></td>
<td>Eliminates fully connected layers → fewer params, less
overfitting</td>
</tr>
<tr class="odd">
<td><strong>No Dropout</strong></td>
<td>Small model + augmentation → sufficient regularization</td>
</tr>
<tr class="even">
<td><strong>Categorical Crossentropy + Softmax</strong></td>
<td>Multi-class (even if binary) → better probability calibration</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-training-configuration">6. Training Configuration</h2>
<p>```python model.compile( optimizer=Adam(learning_rate=1e-3),
loss='categorical_crossentropy', metrics=['accuracy', 'AUC',
'Precision', 'Recall'] )</p>
</section>
<div class="cell code" data-execution_count="18"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:15065,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511427641,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="So20tmpTYrWB" data-outputId="b26509a0-b45b-4834-9780-a4b1dc0bd4ed">
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install mlflow <span class="op">--</span>quiet</span></code></pre></div>
<div class="output stream stdout">
<pre><code>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 40.0/40.0 kB 3.1 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 8.9/8.9 MB 64.8 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.4/2.4 MB 90.4 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.3/1.3 MB 53.2 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 147.8/147.8 kB 11.3 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 114.9/114.9 kB 9.6 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 85.0/85.0 kB 7.2 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 76.8/76.8 kB 6.1 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 753.9/753.9 kB 46.0 MB/s eta 0:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 207.3/207.3 kB 16.4 MB/s eta 0:00:00
</code></pre>
</div>
</div>
<section id="experiment-tracking" class="cell markdown"
id="uh86DLNMrkZS">
<h3>Experiment Tracking</h3>
<ol>
<li>Install MLflow</li>
</ol>
</section>
<section id="2-import--start-mlflow" class="cell markdown"
id="B12-frdzryL4">
<h3>2. Import &amp; Start MLflow</h3>
</section>
<div class="cell code" data-execution_count="19"
data-executionInfo="{&quot;elapsed&quot;:5813,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511433464,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="cECL-Ex9YzS9">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.tensorflow</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.keras</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Auto-log all Keras models</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>mlflow.tensorflow.autolog()</span></code></pre></div>
</div>
<section id="wrap-your-training-in-mlflowstart_run"
class="cell markdown" id="tlqpirCfr5Zq">
<h3>Wrap Your Training in mlflow.start_run()</h3>
</section>
<div class="cell code" data-execution_count="20"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:801}"
data-executionInfo="{&quot;elapsed&quot;:298546,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511732012,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="PavopbtoagPw" data-outputId="6a0aaa80-4947-473d-ab71-612067deb0cd">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HYPERPARAMETERS (change these per experiment) ===</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>IMG_SIZE <span class="op">=</span> (<span class="dv">128</span>, <span class="dv">128</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">1e-3</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>DROPOUT_RATE <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># === START MLflow RUN ===</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f&quot;cnn_lr</span><span class="sc">{</span>LEARNING_RATE<span class="sc">}</span><span class="ss">_bs</span><span class="sc">{</span>BATCH_SIZE<span class="sc">}</span><span class="ss">_img</span><span class="sc">{</span>IMG_SIZE[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">&quot;</span>) <span class="im">as</span> run:</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log hyperparameters</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;img_size&quot;</span>, IMG_SIZE[<span class="dv">0</span>])</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;batch_size&quot;</span>, BATCH_SIZE)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;learning_rate&quot;</span>, LEARNING_RATE)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;dropout_rate&quot;</span>, DROPOUT_RATE)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;epochs&quot;</span>, EPOCHS)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;model_type&quot;</span>, <span class="st">&quot;CustomCNN&quot;</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;augmentation&quot;</span>, <span class="st">&quot;full&quot;</span>)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === PREPARE DATA GENERATORS ===</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recreate generators within this cell to ensure correct class_mode</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assumes &#39;prepare_dataset&#39; function is defined in a previous cell and executed</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try to use existing &#39;path&#39; if available, otherwise assume a default or download</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This part might need adjustment based on how &#39;path&#39; is truly managed</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        dataset_root_path <span class="op">=</span> path <span class="co"># Assuming &#39;path&#39; is the root of the dataset</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Dataset path &#39;path&#39; not found. Assuming a default path or you need to define it.&quot;</span>)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback or error handling if path is not defined</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For now, let&#39;s assume &#39;path&#39; exists from previous cells</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Call the prepare_dataset function to get the generators</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    train_gen, val_gen, test_gen, df_full <span class="op">=</span> prepare_dataset(</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        root_path<span class="op">=</span>dataset_root_path, <span class="co"># Use the dataset root path</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        img_size<span class="op">=</span>IMG_SIZE,</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>BATCH_SIZE</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure label2index and index2label are available from the generators</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    label2index <span class="op">=</span> train_gen.class_indices</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    index2label <span class="op">=</span> {v: k <span class="cf">for</span> k, v <span class="kw">in</span> label2index.items()}</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Label mapping (label -&gt; index):&quot;</span>, label2index)</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === BUILD MODEL ===</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, Dense, Flatten, Dropout, BatchNormalization, GlobalAveragePooling2D</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    num_classes <span class="op">=</span> <span class="bu">len</span>(label2index) <span class="co"># Get num_classes from the generator</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>        Conv2D(<span class="dv">32</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, input_shape<span class="op">=</span>(<span class="op">*</span>IMG_SIZE, <span class="dv">3</span>)),</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>        Conv2D(<span class="dv">64</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>        Conv2D(<span class="dv">128</span>, <span class="dv">3</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>        GlobalAveragePooling2D(),</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>        Dropout(DROPOUT_RATE),</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>        Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>) <span class="co"># Use num_classes from generator</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span>LEARNING_RATE),</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>        loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>,</span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>        metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>, <span class="st">&#39;AUC&#39;</span>, <span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>]</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === CALLBACKS ===</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> EarlyStopping, ReduceLROnPlateau, ModelCheckpoint</span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>    callbacks <span class="op">=</span> [</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>        EarlyStopping(patience<span class="op">=</span><span class="dv">7</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>        ReduceLROnPlateau(patience<span class="op">=</span><span class="dv">3</span>, factor<span class="op">=</span><span class="fl">0.5</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>        ModelCheckpoint(<span class="st">&quot;best_model.h5&quot;</span>, save_best_only<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>)</span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === TRAIN ===</span></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> model.fit(</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>        train_gen,</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>        validation_data<span class="op">=</span>val_gen,</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span>EPOCHS,</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>        callbacks<span class="op">=</span>callbacks,</span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG FINAL METRICS ===</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>    best_val_acc <span class="op">=</span> <span class="bu">max</span>(history.history[<span class="st">&#39;val_accuracy&#39;</span>])</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if &#39;val_auc&#39; is in history before accessing it</span></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>    best_val_auc <span class="op">=</span> <span class="bu">max</span>(history.history[<span class="st">&#39;val_auc&#39;</span>]) <span class="cf">if</span> <span class="st">&#39;val_auc&#39;</span> <span class="kw">in</span> history.history <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;best_val_accuracy&quot;</span>, best_val_acc)</span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_val_auc <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>      mlflow.log_metric(<span class="st">&quot;best_val_auc&quot;</span>, best_val_auc)</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;final_train_loss&quot;</span>, history.history[<span class="st">&#39;loss&#39;</span>][<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG MODEL ===</span></span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>    mlflow.keras.log_model(model, <span class="st">&quot;model&quot;</span>)</span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG CONFUSION MATRIX PLOT ===</span></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to reset test_gen before predicting</span></span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>    test_gen.reset()</span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get true labels from the test generator</span></span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> test_gen.classes</span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict probabilities</span></span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>    y_pred_probs <span class="op">=</span> model.predict(test_gen)</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get predicted class indices</span></span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_pred_probs, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&#39;d&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Blues&#39;</span>,</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>test_gen.class_indices.keys(),</span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>                yticklabels<span class="op">=</span>test_gen.class_indices.keys())</span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Confusion Matrix&quot;</span>)</span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;True&quot;</span>)</span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted&quot;</span>)</span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;confusion_matrix.png&quot;</span>)</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;confusion_matrix.png&quot;</span>)</span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;best_model.h5&quot;</span>)</span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;MLflow Run ID: </span><span class="sc">{</span>run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/mlflow/tracking/_tracking_service/utils.py:140: FutureWarning: Filesystem tracking backend (e.g., &#39;./mlruns&#39;) is deprecated. Please switch to a database backend (e.g., &#39;sqlite:///mlflow.db&#39;). For feedback, see: https://github.com/mlflow/mlflow/issues/18534
  return FileStore(store_uri, store_uri)
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>Found 249 validated image filenames belonging to 2 classes.
Found 54 validated image filenames belonging to 2 classes.
Found 54 validated image filenames belonging to 2 classes.
Label mapping (label -&gt; index): {&#39;healthy_eye&#39;: 0, &#39;infected_eye&#39;: 1}
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>/usr/local/lib/python3.12/dist-packages/keras/src/layers/convolutional/base_conv.py:113: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(activity_regularizer=activity_regularizer, **kwargs)
2025/11/19 00:17:17 WARNING mlflow.tensorflow: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
2025/11/19 00:17:17 WARNING mlflow.tensorflow: Unrecognized dataset type &lt;class &#39;keras.src.legacy.preprocessing.image.DataFrameIterator&#39;&gt;. Dataset logging skipped.
/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output display_data">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>

</div>
<div class="output stream stdout">
<pre><code>Epoch 1/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 3s/step - AUC: 0.6543 - Precision: 0.5983 - Recall: 0.5983 - accuracy: 0.5983 - loss: 0.6652</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 41s 3s/step - AUC: 0.6660 - Precision: 0.6072 - Recall: 0.6072 - accuracy: 0.6072 - loss: 0.6570 - val_AUC: 0.5676 - val_Precision: 0.5000 - val_Recall: 0.5000 - val_accuracy: 0.5000 - val_loss: 0.6916 - learning_rate: 0.0010
Epoch 2/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 0s 3s/step - AUC: 0.8861 - Precision: 0.8176 - Recall: 0.8176 - accuracy: 0.8176 - loss: 0.4374</code></pre>
</div>
<div class="output stream stderr">
<pre><code>WARNING:absl:You are saving your model as an HDF5 file via `model.save()` or `keras.saving.save_model(model)`. This file format is considered legacy. We recommend using instead the native Keras format, e.g. `model.save(&#39;my_model.keras&#39;)` or `keras.saving.save_model(model, &#39;my_model.keras&#39;)`. 
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>8/8 ━━━━━━━━━━━━━━━━━━━━ 26s 3s/step - AUC: 0.8861 - Precision: 0.8169 - Recall: 0.8169 - accuracy: 0.8169 - loss: 0.4365 - val_AUC: 0.6421 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.6853 - learning_rate: 0.0010
Epoch 3/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 27s 3s/step - AUC: 0.8875 - Precision: 0.8010 - Recall: 0.8010 - accuracy: 0.8010 - loss: 0.4155 - val_AUC: 0.5720 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7036 - learning_rate: 0.0010
Epoch 4/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 28s 3s/step - AUC: 0.8857 - Precision: 0.8201 - Recall: 0.8201 - accuracy: 0.8201 - loss: 0.4213 - val_AUC: 0.5586 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.6971 - learning_rate: 0.0010
Epoch 5/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 41s 3s/step - AUC: 0.8958 - Precision: 0.7889 - Recall: 0.7889 - accuracy: 0.7889 - loss: 0.4058 - val_AUC: 0.6121 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7215 - learning_rate: 0.0010
Epoch 6/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 25s 3s/step - AUC: 0.9495 - Precision: 0.8658 - Recall: 0.8658 - accuracy: 0.8658 - loss: 0.2992 - val_AUC: 0.5484 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7431 - learning_rate: 5.0000e-04
Epoch 7/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 39s 3s/step - AUC: 0.9359 - Precision: 0.8600 - Recall: 0.8600 - accuracy: 0.8600 - loss: 0.3217 - val_AUC: 0.5226 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7715 - learning_rate: 5.0000e-04
Epoch 8/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 15s 2s/step - AUC: 0.9431 - Precision: 0.8468 - Recall: 0.8468 - accuracy: 0.8468 - loss: 0.3044 - val_AUC: 0.5364 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.7888 - learning_rate: 5.0000e-04
Epoch 9/50
8/8 ━━━━━━━━━━━━━━━━━━━━ 15s 2s/step - AUC: 0.9660 - Precision: 0.8822 - Recall: 0.8822 - accuracy: 0.8822 - loss: 0.2606 - val_AUC: 0.5257 - val_Precision: 0.4815 - val_Recall: 0.4815 - val_accuracy: 0.4815 - val_loss: 0.8051 - learning_rate: 2.5000e-04
</code></pre>
</div>
<div class="output stream stderr">
<pre><code>2025/11/19 00:21:39 WARNING mlflow.tensorflow: Failed to infer model signature: could not sample data to infer model signature: &#39;&gt;=&#39; not supported between instances of &#39;slice&#39; and &#39;int&#39;
2025/11/19 00:21:39 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/11/19 00:21:39 WARNING mlflow.tensorflow: You are saving a TensorFlow Core model or Keras model without a signature. Inference with mlflow.pyfunc.spark_udf() will not work unless the model&#39;s pyfunc representation accepts pandas DataFrames as inference inputs.
2025/11/19 00:21:57 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.
2025/11/19 00:21:58 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/11/19 00:21:58 WARNING mlflow.keras.save: You are saving a Keras model without specifying model signature.
2025/11/19 00:22:09 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.
/usr/local/lib/python3.12/dist-packages/keras/src/trainers/data_adapters/py_dataset_adapter.py:121: UserWarning: Your `PyDataset` class should call `super().__init__(**kwargs)` in its constructor. `**kwargs` can include `workers`, `use_multiprocessing`, `max_queue_size`. Do not pass these arguments to `fit()`, as they will be ignored.
  self._warn_if_super_not_called()
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>2/2 ━━━━━━━━━━━━━━━━━━━━ 1s 301ms/step
MLflow Run ID: fea62498a0da4b0680d8d52ece59a9db
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="21"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:1521,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511733544,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="6084140f-6b54-42a4-8f12-0f1317862048"
data-outputId="93966e28-de91-4890-e7cd-70e191ac79d3">
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install ngrok by downloading the binary</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>wget https:<span class="op">//</span><span class="bu">bin</span>.equinox.io<span class="op">/</span>c<span class="op">/</span><span class="dv">4</span><span class="er">VmDzA7iaHb</span><span class="op">/</span>ngrok<span class="op">-</span>stable<span class="op">-</span>linux<span class="op">-</span>amd64.<span class="bu">zip</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>unzip ngrok<span class="op">-</span>stable<span class="op">-</span>linux<span class="op">-</span>amd64.<span class="bu">zip</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>chmod <span class="op">+</span>x ngrok</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>sudo mv ngrok <span class="op">/</span>usr<span class="op">/</span>local<span class="op">/</span><span class="bu">bin</span><span class="op">/</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>--2025-11-19 00:22:11--  https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
Resolving bin.equinox.io (bin.equinox.io)... 75.2.60.68, 35.71.179.82, 99.83.220.108, ...
Connecting to bin.equinox.io (bin.equinox.io)|75.2.60.68|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 13921656 (13M) [application/octet-stream]
Saving to: ‘ngrok-stable-linux-amd64.zip’

ngrok-stable-linux- 100%[===================&gt;]  13.28M  43.0MB/s    in 0.3s    

2025-11-19 00:22:12 (43.0 MB/s) - ‘ngrok-stable-linux-amd64.zip’ saved [13921656/13921656]

Archive:  ngrok-stable-linux-amd64.zip
  inflating: ngrok                   
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="22"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-executionInfo="{&quot;elapsed&quot;:93,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1763511733660,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="sXgd9LGnlPS5" data-outputId="dc47558e-9f92-4ee1-d561-0f0fbcb61c29">
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>ngrok authtoken <span class="dv">34</span><span class="er">kPpTGbA8SPniLPhSFXRl3VjEE_4pT93d7LLqCaiq4j8Ub9m</span> <span class="co"># replace with your own ngrok authtoken</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Authtoken saved to configuration file: /root/.ngrok2/ngrok.yml
</code></pre>
</div>
</div>
<section id="4-launch-mlflow-ui" class="cell markdown"
id="PFP2nHEssFoJ">
<h3>4. Launch MLflow UI</h3>
</section>
<div class="cell code" data-execution_count="23"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:383}"
data-executionInfo="{&quot;elapsed&quot;:34,&quot;status&quot;:&quot;error&quot;,&quot;timestamp&quot;:1763511733696,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="Fry3aEdrgc1I" data-outputId="93a20633-15d2-439a-bdbf-648c40960a69">
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kill any running ngrok processes to free up the address</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use pyngrok&#39;s kill function for reliability</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok <span class="co"># Ensure ngrok is imported here before killing</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>ngrok.kill()</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Existing ngrok processes killed.&quot;</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow UI in background</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>get_ipython().system_raw(<span class="st">&quot;mlflow ui --port 5000 &amp;&quot;</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tunnel using ngrok (install first if needed)</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install pyngrok <span class="op">--</span>quiet</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your ngrok authtoken for pyngrok</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>ngrok.set_auth_token(<span class="st">&quot;34kPpTGbA8SPniLPhSFXRl3VjEE_4pT93d7LLqCaiq4j8Ub9m&quot;</span>)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>public_url <span class="op">=</span> ngrok.<span class="ex">connect</span>(<span class="dv">5000</span>)</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;MLflow UI: </span><span class="sc">{</span>public_url<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output error" data-ename="ModuleNotFoundError"
data-evalue="No module named &#39;pyngrok&#39;">
<pre><code>---------------------------------------------------------------------------
ModuleNotFoundError                       Traceback (most recent call last)
/tmp/ipython-input-1049515958.py in &lt;cell line: 0&gt;()
      1 # Kill any running ngrok processes to free up the address
      2 # Use pyngrok&#39;s kill function for reliability
----&gt; 3 from pyngrok import ngrok # Ensure ngrok is imported here before killing
      4 ngrok.kill()
      5 print(&quot;Existing ngrok processes killed.&quot;)

ModuleNotFoundError: No module named &#39;pyngrok&#39;

---------------------------------------------------------------------------
NOTE: If your import is failing due to a missing package, you can
manually install dependencies using either !pip or !apt.

To view examples of installing some common dependencies, click the
&quot;Open Examples&quot; button below.
---------------------------------------------------------------------------

</code></pre>
</div>
</div>
<div class="cell code" id="E8dK1bPCgZBJ">
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
<section id="run-multiple-experiments-hyperparameter-search"
class="cell markdown" id="doIzn3TFsO4W">
<h3>Run Multiple Experiments (Hyperparameter Search)</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904859,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733706,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="CzQqgf7Ol1q_">
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Experiment 1</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">1e-3</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># → Run the block above</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Experiment 2</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">5e-4</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">16</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co"># → Run again</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Experiment 3</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>LEARNING_RATE <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co"># → Run again</span></span></code></pre></div>
</div>
<section id="add-hyperparameter-tuning-with-keras-tuner"
class="cell markdown" id="pwJqZar-sSE6">
<h3>Add Hyperparameter Tuning with Keras Tuner</h3>
<ol>
<li>Install Keras Tuner</li>
</ol>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904859,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733707,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="e_c3pBdGmZOy">
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install keras<span class="op">-</span>tuner <span class="op">--</span>quiet</span></code></pre></div>
</div>
<section id="2-define-the-model-builder-function-hypermodel"
class="cell markdown" id="lmJf7vw8srFw">
<h3>2. Define the Model Builder Function (Hypermodel)</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904860,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733708,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="jae9q4PnmhY4">
<div class="sourceCode" id="cb58"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras_tuner <span class="im">as</span> kt</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, Dense, Dropout, BatchNormalization, GlobalAveragePooling2D</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_model(hp):</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential([</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        Conv2D(</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>            input_shape<span class="op">=</span>(<span class="dv">224</span>, <span class="dv">224</span>, <span class="dv">3</span>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>        Conv2D(</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;relu&#39;</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>        MaxPooling2D(<span class="dv">2</span>),</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        Conv2D(</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;relu&#39;</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>        BatchNormalization(),</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>        GlobalAveragePooling2D(),</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>        Dropout(</span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>            rate<span class="op">=</span>hp.Float(<span class="st">&#39;dropout&#39;</span>, min_value<span class="op">=</span><span class="fl">0.3</span>, max_value<span class="op">=</span><span class="fl">0.5</span>, step<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>        Dense(<span class="dv">2</span>, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tune learning rate</span></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> hp.Choice(<span class="st">&#39;learning_rate&#39;</span>, values<span class="op">=</span>[<span class="fl">1e-3</span>, <span class="fl">5e-4</span>, <span class="fl">1e-4</span>])</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>        optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span>lr),</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>        loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>,</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>        metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>, <span class="st">&#39;AUC&#39;</span>, <span class="st">&#39;Precision&#39;</span>, <span class="st">&#39;Recall&#39;</span>]</span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span></code></pre></div>
</div>
<section id="set-up-callbacks" class="cell markdown" id="kKt0NPq4syVp">
<h3>Set Up Callbacks</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904869,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733717,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="rTP3f46JmmT6">
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> EarlyStopping, ReduceLROnPlateau, ModelCheckpoint</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>callbacks <span class="op">=</span> [</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    EarlyStopping(patience<span class="op">=</span><span class="dv">7</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    ReduceLROnPlateau(patience<span class="op">=</span><span class="dv">3</span>, factor<span class="op">=</span><span class="fl">0.5</span>, monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    ModelCheckpoint(<span class="st">&quot;best_model_tuner.h5&quot;</span>, save_best_only<span class="op">=</span><span class="va">True</span>, monitor<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
</div>
<section id="run-hyperparameter-search-with-mlflow-tracking"
class="cell markdown" id="e-lxVDTls4I7">
<h3>Run Hyperparameter Search with MLflow Tracking</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904870,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733719,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="V7GxLxKcmqtq">
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.keras</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable autologging</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>mlflow.keras.autolog()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define search space</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> kt.RandomSearch(</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    build_model,</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>,</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    max_trials<span class="op">=</span><span class="dv">6</span>,  <span class="co"># 2 batch sizes × 3 LRs = 6 combos</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    executions_per_trial<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    directory<span class="op">=</span><span class="st">&#39;tuner_dir&#39;</span>,</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">&#39;conjunctivitis_tuning&#39;</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run for the *entire search*</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Hyperparameter_Search_RandomSearch&quot;</span>) <span class="im">as</span> tuning_run:</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;tuner_type&quot;</span>, <span class="st">&quot;RandomSearch&quot;</span>)</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;max_trials&quot;</span>, <span class="dv">6</span>)</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;objective&quot;</span>, <span class="st">&quot;val_accuracy&quot;</span>)</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Starting hyperparameter search...&quot;</span>)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>    tuner.search(</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>        train_gen,</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>        validation_data<span class="op">=</span>val_gen,</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>        epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>        callbacks<span class="op">=</span>callbacks,</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get best model</span></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> tuner.get_best_models(num_models<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>    best_hyperparameters <span class="op">=</span> tuner.get_best_hyperparameters(num_trials<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log best hyperparameters</span></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>    mlflow.log_params({</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;best_learning_rate&quot;</span>: best_hyperparameters.get(<span class="st">&#39;learning_rate&#39;</span>),</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;best_dropout&quot;</span>: best_hyperparameters.get(<span class="st">&#39;dropout&#39;</span>),</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;best_batch_size&quot;</span>: train_gen.batch_size  <span class="co"># We&#39;ll set this below</span></span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate on test set</span></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>    test_loss, test_acc, test_auc, test_precision, test_recall <span class="op">=</span> best_model.evaluate(test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metrics({</span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_accuracy&quot;</span>: test_acc,</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_auc&quot;</span>: test_auc,</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_precision&quot;</span>: test_precision,</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;test_recall&quot;</span>: test_recall</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save best model</span></span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a>    best_model.save(<span class="st">&quot;best_tuned_model.h5&quot;</span>)</span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;best_tuned_model.h5&quot;</span>)</span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Best val accuracy: </span><span class="sc">{</span>tuner<span class="sc">.</span>oracle<span class="sc">.</span>get_best_trials(<span class="dv">1</span>)[<span class="dv">0</span>]<span class="sc">.</span>score<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Best hyperparameters: </span><span class="sc">{</span>best_hyperparameters<span class="sc">.</span>values<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell markdown" id="fecxw03ZtY0E">
<p>Handle Batch Size in Search (Keras Tuner Can’t Change batch_size in
.fit()) We loop over batch sizes manually and let Keras Tuner tune the
rest:</p>
</div>
<section id="6-view-results-in-mlflow-ui" class="cell markdown"
id="RKazu0d9tgRq">
<h3>6. View Results in MLflow UI</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904871,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733720,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="LbiF0yUUm348">
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch UI (run once)</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>get_ipython().system_raw(<span class="st">&quot;mlflow ui --port 5000 &amp;&quot;</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;MLflow UI:&quot;</span>, ngrok.<span class="ex">connect</span>(<span class="dv">5000</span>))</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904872,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733721,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="luGDgPRRmynw">
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === FULL HYPERPARAMETER SEARCH WITH BATCH SIZE LOOP ===</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator <span class="co"># Import ImageDataGenerator</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras_tuner <span class="im">as</span> kt <span class="co"># Import keras_tuner here</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>batch_sizes <span class="op">=</span> [<span class="dv">16</span>, <span class="dv">32</span>]</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define ImageDataGenerator objects globally for use within the loop</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>train_datagen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    rotation_range<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    width_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>    height_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    horizontal_flip<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    fill_mode<span class="op">=</span><span class="st">&#39;nearest&#39;</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>val_datagen <span class="op">=</span> ImageDataGenerator(rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>) <span class="co"># Use a separate object for validation/test</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Full_Hyperparameter_Search&quot;</span>) <span class="im">as</span> parent_run:</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    best_overall_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    best_model_overall <span class="op">=</span> <span class="va">None</span> <span class="co"># Renamed to avoid conflict</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    best_hps_overall <span class="op">=</span> <span class="va">None</span>   <span class="co"># Renamed to avoid conflict</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    best_batch_size_overall <span class="op">=</span> <span class="va">None</span> <span class="co"># Renamed to avoid conflict</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assume train_df, val_df, test_df are defined in a previous cell</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        train_df</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        val_df</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        test_df</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;DataFrames (train_df, val_df, test_df) not found. Please ensure they are created before running this cell.&quot;</span>)</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Exit or handle error appropriately if dataframes are missing</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For now, we&#39;ll assume they exist from previous steps</span></span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === HYPERPARAMETERS (change these per experiment) ===</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>    IMG_SIZE <span class="op">=</span> (<span class="dv">128</span>, <span class="dv">128</span>) <span class="co"># Reduced image size for faster tuning</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># BATCH_SIZE = 32 # This will be overridden by the loop</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LEARNING_RATE = 1e-3 # This will be tuned by Keras Tuner</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DROPOUT_RATE = 0.3 # This will be tuned by Keras Tuner</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    EPOCHS <span class="op">=</span> <span class="dv">50</span> <span class="co"># You might also reduce epochs for faster tuning</span></span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch_size <span class="kw">in</span> batch_sizes:</span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">=== Tuning with batch_size = </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> ===&quot;</span>)</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Recreate data generators with new batch size and smaller image size</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the globally defined datagen objects</span></span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>        train_gen_bs <span class="op">=</span> train_datagen.flow_from_dataframe(</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>            train_df,</span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size,</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">True</span></span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>        val_gen_bs <span class="op">=</span> val_datagen.flow_from_dataframe(</span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a>            val_df,</span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb62-61"><a href="#cb62-61" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size,</span>
<span id="cb62-62"><a href="#cb62-62" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb62-63"><a href="#cb62-63" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">False</span></span>
<span id="cb62-64"><a href="#cb62-64" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb62-65"><a href="#cb62-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Also create test_gen_bs for evaluation later</span></span>
<span id="cb62-66"><a href="#cb62-66" aria-hidden="true" tabindex="-1"></a>        test_gen_bs <span class="op">=</span> val_datagen.flow_from_dataframe(</span>
<span id="cb62-67"><a href="#cb62-67" aria-hidden="true" tabindex="-1"></a>            test_df,</span>
<span id="cb62-68"><a href="#cb62-68" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb62-69"><a href="#cb62-69" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb62-70"><a href="#cb62-70" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb62-71"><a href="#cb62-71" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>batch_size, <span class="co"># Use the current batch_size for test as well</span></span>
<span id="cb62-72"><a href="#cb62-72" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb62-73"><a href="#cb62-73" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">False</span></span>
<span id="cb62-74"><a href="#cb62-74" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb62-75"><a href="#cb62-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-76"><a href="#cb62-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-77"><a href="#cb62-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># New tuner per batch size</span></span>
<span id="cb62-78"><a href="#cb62-78" aria-hidden="true" tabindex="-1"></a>        tuner <span class="op">=</span> kt.RandomSearch(</span>
<span id="cb62-79"><a href="#cb62-79" aria-hidden="true" tabindex="-1"></a>            build_model, <span class="co"># build_model function must be defined in a previous cell</span></span>
<span id="cb62-80"><a href="#cb62-80" aria-hidden="true" tabindex="-1"></a>            objective<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>,</span>
<span id="cb62-81"><a href="#cb62-81" aria-hidden="true" tabindex="-1"></a>            max_trials<span class="op">=</span><span class="dv">3</span>,  <span class="co"># 3 LRs × 2 dropouts = 6, but we limit to 3 trials per batch size</span></span>
<span id="cb62-82"><a href="#cb62-82" aria-hidden="true" tabindex="-1"></a>            executions_per_trial<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb62-83"><a href="#cb62-83" aria-hidden="true" tabindex="-1"></a>            directory<span class="op">=</span><span class="ss">f&#39;tuner_dir_bs</span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb62-84"><a href="#cb62-84" aria-hidden="true" tabindex="-1"></a>            project_name<span class="op">=</span><span class="st">&#39;conjunctivitis_tuning_bs&#39;</span> <span class="co"># Unique project name per batch size to avoid conflicts</span></span>
<span id="cb62-85"><a href="#cb62-85" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb62-86"><a href="#cb62-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-87"><a href="#cb62-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(nested<span class="op">=</span><span class="va">True</span>, run_name<span class="op">=</span><span class="ss">f&quot;batch_size_</span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>) <span class="im">as</span> child_run:</span>
<span id="cb62-88"><a href="#cb62-88" aria-hidden="true" tabindex="-1"></a>            mlflow.log_param(<span class="st">&quot;batch_size&quot;</span>, batch_size)</span>
<span id="cb62-89"><a href="#cb62-89" aria-hidden="true" tabindex="-1"></a>            mlflow.log_param(<span class="st">&quot;img_size&quot;</span>, IMG_SIZE[<span class="dv">0</span>]) <span class="co"># Log the image size for this run</span></span>
<span id="cb62-90"><a href="#cb62-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-91"><a href="#cb62-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-92"><a href="#cb62-92" aria-hidden="true" tabindex="-1"></a>            tuner.search(</span>
<span id="cb62-93"><a href="#cb62-93" aria-hidden="true" tabindex="-1"></a>                train_gen_bs,</span>
<span id="cb62-94"><a href="#cb62-94" aria-hidden="true" tabindex="-1"></a>                validation_data<span class="op">=</span>val_gen_bs,</span>
<span id="cb62-95"><a href="#cb62-95" aria-hidden="true" tabindex="-1"></a>                epochs<span class="op">=</span>EPOCHS,</span>
<span id="cb62-96"><a href="#cb62-96" aria-hidden="true" tabindex="-1"></a>                callbacks<span class="op">=</span>callbacks, <span class="co"># callbacks list must be defined in a previous cell</span></span>
<span id="cb62-97"><a href="#cb62-97" aria-hidden="true" tabindex="-1"></a>                verbose<span class="op">=</span><span class="dv">0</span></span>
<span id="cb62-98"><a href="#cb62-98" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb62-99"><a href="#cb62-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-100"><a href="#cb62-100" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the best trial and its score for this batch size</span></span>
<span id="cb62-101"><a href="#cb62-101" aria-hidden="true" tabindex="-1"></a>            best_trial_for_bs <span class="op">=</span> tuner.oracle.get_best_trials(<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb62-102"><a href="#cb62-102" aria-hidden="true" tabindex="-1"></a>            score_for_bs <span class="op">=</span> best_trial_for_bs.score</span>
<span id="cb62-103"><a href="#cb62-103" aria-hidden="true" tabindex="-1"></a>            hps_for_bs <span class="op">=</span> best_trial_for_bs.hyperparameters.values <span class="co"># Keep this line as it correctly gets the dict</span></span>
<span id="cb62-104"><a href="#cb62-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-105"><a href="#cb62-105" aria-hidden="true" tabindex="-1"></a>            mlflow.log_metric(<span class="st">&quot;val_accuracy_for_batch_size&quot;</span>, score_for_bs)</span>
<span id="cb62-106"><a href="#cb62-106" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Log hyperparameters for this batch size run (Keras Tuner autologging should handle most)</span></span>
<span id="cb62-107"><a href="#cb62-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># mlflow.log_params(hps_for_bs) # Removed to avoid conflict with autologging</span></span>
<span id="cb62-108"><a href="#cb62-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-109"><a href="#cb62-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-110"><a href="#cb62-110" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if this batch size&#39;s best score is the overall best</span></span>
<span id="cb62-111"><a href="#cb62-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> score_for_bs <span class="op">&gt;</span> best_overall_score:</span>
<span id="cb62-112"><a href="#cb62-112" aria-hidden="true" tabindex="-1"></a>                best_overall_score <span class="op">=</span> score_for_bs</span>
<span id="cb62-113"><a href="#cb62-113" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get the best model and hyperparameters from the tuner</span></span>
<span id="cb62-114"><a href="#cb62-114" aria-hidden="true" tabindex="-1"></a>                best_model_overall <span class="op">=</span> tuner.get_best_models(<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb62-115"><a href="#cb62-115" aria-hidden="true" tabindex="-1"></a>                best_hps_overall <span class="op">=</span> tuner.get_best_hyperparameters(<span class="dv">1</span>)[<span class="dv">0</span>].values <span class="co"># Get as dict</span></span>
<span id="cb62-116"><a href="#cb62-116" aria-hidden="true" tabindex="-1"></a>                best_batch_size_overall <span class="op">=</span> batch_size</span>
<span id="cb62-117"><a href="#cb62-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-118"><a href="#cb62-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG BEST OVERALL ===</span></span>
<span id="cb62-119"><a href="#cb62-119" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;best_overall_val_accuracy&quot;</span>, best_overall_score)</span>
<span id="cb62-120"><a href="#cb62-120" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;best_overall_batch_size&quot;</span>, best_batch_size_overall)</span>
<span id="cb62-121"><a href="#cb62-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_hps_overall:</span>
<span id="cb62-122"><a href="#cb62-122" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_hps_overall)</span>
<span id="cb62-123"><a href="#cb62-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-124"><a href="#cb62-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluate the best overall model on the test set</span></span>
<span id="cb62-125"><a href="#cb62-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to ensure test_gen corresponds to the best_batch_size</span></span>
<span id="cb62-126"><a href="#cb62-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recreate test_gen one last time with the best overall batch size</span></span>
<span id="cb62-127"><a href="#cb62-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_batch_size_overall <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb62-128"><a href="#cb62-128" aria-hidden="true" tabindex="-1"></a>        final_test_gen <span class="op">=</span> val_datagen.flow_from_dataframe(</span>
<span id="cb62-129"><a href="#cb62-129" aria-hidden="true" tabindex="-1"></a>            test_df,</span>
<span id="cb62-130"><a href="#cb62-130" aria-hidden="true" tabindex="-1"></a>            x_col<span class="op">=</span><span class="st">&#39;image_path&#39;</span>,</span>
<span id="cb62-131"><a href="#cb62-131" aria-hidden="true" tabindex="-1"></a>            y_col<span class="op">=</span><span class="st">&#39;label&#39;</span>,</span>
<span id="cb62-132"><a href="#cb62-132" aria-hidden="true" tabindex="-1"></a>            target_size<span class="op">=</span>IMG_SIZE, <span class="co"># Use the reduced IMG_SIZE</span></span>
<span id="cb62-133"><a href="#cb62-133" aria-hidden="true" tabindex="-1"></a>            batch_size<span class="op">=</span>best_batch_size_overall,</span>
<span id="cb62-134"><a href="#cb62-134" aria-hidden="true" tabindex="-1"></a>            class_mode<span class="op">=</span><span class="st">&#39;categorical&#39;</span>,</span>
<span id="cb62-135"><a href="#cb62-135" aria-hidden="true" tabindex="-1"></a>            shuffle<span class="op">=</span><span class="va">False</span></span>
<span id="cb62-136"><a href="#cb62-136" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb62-137"><a href="#cb62-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb62-138"><a href="#cb62-138" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Handle case where no trials were successful</span></span>
<span id="cb62-139"><a href="#cb62-139" aria-hidden="true" tabindex="-1"></a>         final_test_gen <span class="op">=</span> <span class="va">None</span></span>
<span id="cb62-140"><a href="#cb62-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-141"><a href="#cb62-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-142"><a href="#cb62-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to ensure best_model_overall is not None if no trials ran</span></span>
<span id="cb62-143"><a href="#cb62-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_model_overall <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> final_test_gen <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb62-144"><a href="#cb62-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Unpack all metrics returned by evaluate()</span></span>
<span id="cb62-145"><a href="#cb62-145" aria-hidden="true" tabindex="-1"></a>        test_loss, test_acc, test_auc, test_precision, test_recall <span class="op">=</span> best_model_overall.evaluate(final_test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb62-146"><a href="#cb62-146" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_accuracy&quot;</span>, test_acc)</span>
<span id="cb62-147"><a href="#cb62-147" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_loss&quot;</span>, test_loss) <span class="co"># Log test loss too</span></span>
<span id="cb62-148"><a href="#cb62-148" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_auc&quot;</span>, test_auc)</span>
<span id="cb62-149"><a href="#cb62-149" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_precision&quot;</span>, test_precision)</span>
<span id="cb62-150"><a href="#cb62-150" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">&quot;final_test_recall&quot;</span>, test_recall)</span>
<span id="cb62-151"><a href="#cb62-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-152"><a href="#cb62-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-153"><a href="#cb62-153" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save best model</span></span>
<span id="cb62-154"><a href="#cb62-154" aria-hidden="true" tabindex="-1"></a>        best_model_overall.save(<span class="st">&quot;final_best_model.h5&quot;</span>)</span>
<span id="cb62-155"><a href="#cb62-155" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">&quot;final_best_model.h5&quot;</span>)</span>
<span id="cb62-156"><a href="#cb62-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb62-157"><a href="#cb62-157" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;No successful tuning trials or test generator to log best model results.&quot;</span>)</span>
<span id="cb62-158"><a href="#cb62-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-159"><a href="#cb62-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-160"><a href="#cb62-160" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">BEST OVERALL MODEL: batch_size=</span><span class="sc">{</span>best_batch_size_overall<span class="sc">}</span><span class="ss">, val_acc=</span><span class="sc">{</span>best_overall_score<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb62-161"><a href="#cb62-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_hps_overall:</span>
<span id="cb62-162"><a href="#cb62-162" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Hyperparameters: </span><span class="sc">{</span>best_hps_overall<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell markdown" id="kiGtl4g9yMo7">
<p>###Install Extra Dependencies</p>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904873,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733722,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="fTyZenlcySA7">
<div class="sourceCode" id="cb63"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install scikit<span class="op">-</span>learn matplotlib seaborn <span class="op">--</span>quiet</span></code></pre></div>
</div>
<section id="2-load-your-best-model" class="cell markdown"
id="_E4GReccyXXC">
<h3>2. Load Your Best Model</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904893,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733743,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="ISxmTghCyZi5">
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> load_model</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace with your actual path</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> load_model(<span class="st">&quot;final_best_model.h5&quot;</span>)</span></code></pre></div>
</div>
<section id="3-full-evaluation-with-all-metrics" class="cell markdown"
id="T5DdEGaPyqAV">
<h3>3. Full Evaluation with All Metrics</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904894,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733744,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="PhWM8iD4yvuC">
<div class="sourceCode" id="cb65"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    roc_curve, auc, precision_recall_curve, average_precision_score,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    confusion_matrix, classification_report, cohen_kappa_score</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run for evaluation</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Full_Metric_Evaluation&quot;</span>) <span class="im">as</span> eval_run:</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === PREDICTIONS ===</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    y_pred_prob <span class="op">=</span> best_model.predict(test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_pred_prob, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> test_gen.classes</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get class labels</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())  <span class="co"># [&#39;healthy_eye&#39;, &#39;infected_eye&#39;]</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 1. ROC-AUC (One-vs-Rest) ===</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> label_binarize</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    y_true_bin <span class="op">=</span> label_binarize(y_true, classes<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, _ <span class="op">=</span> roc_curve(y_true_bin.ravel(), y_pred_prob[:, <span class="dv">1</span>])</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    plt.plot(fpr, tpr, color<span class="op">=</span><span class="st">&#39;darkorange&#39;</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f&#39;ROC curve (AUC = </span><span class="sc">{</span>roc_auc<span class="sc">:.3f}</span><span class="ss">)&#39;</span>)</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>    plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], color<span class="op">=</span><span class="st">&#39;navy&#39;</span>, lw<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>)</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    plt.xlim([<span class="fl">0.0</span>, <span class="fl">1.0</span>])</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>    plt.ylim([<span class="fl">0.0</span>, <span class="fl">1.05</span>])</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;False Positive Rate&#39;</span>)</span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;True Positive Rate&#39;</span>)</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&#39;ROC Curve&#39;</span>)</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">&quot;lower right&quot;</span>)</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>    plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;roc_curve.png&quot;</span>)</span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;roc_curve.png&quot;</span>)</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 2. PR-AUC ===</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>    precision, recall, _ <span class="op">=</span> precision_recall_curve(y_true_bin.ravel(), y_pred_prob[:, <span class="dv">1</span>])</span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>    pr_auc <span class="op">=</span> average_precision_score(y_true_bin, y_pred_prob[:, <span class="dv">1</span>])</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>    plt.plot(recall, precision, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>, lw<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f&#39;PR curve (AP = </span><span class="sc">{</span>pr_auc<span class="sc">:.3f}</span><span class="ss">)&#39;</span>)</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&#39;Recall&#39;</span>)</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&#39;Precision&#39;</span>)</span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&#39;Precision-Recall Curve&#39;</span>)</span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">&quot;upper right&quot;</span>)</span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a>    plt.grid(alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;pr_curve.png&quot;</span>)</span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;pr_curve.png&quot;</span>)</span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 3. Confusion Matrix + Per-class Metrics ===</span></span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_true, y_pred)</span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>    tn, fp, fn, tp <span class="op">=</span> cm.ravel()</span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>    sensitivity <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fn)  <span class="co"># Recall for infected</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>    specificity <span class="op">=</span> tn <span class="op">/</span> (tn <span class="op">+</span> fp)  <span class="co"># True Negative Rate for healthy</span></span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>    precision_pos <span class="op">=</span> tp <span class="op">/</span> (tp <span class="op">+</span> fp)</span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a>    f1_pos <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> precision_pos <span class="op">*</span> sensitivity <span class="op">/</span> (precision_pos <span class="op">+</span> sensitivity)</span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">6</span>,<span class="dv">5</span>))</span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&#39;d&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Blues&#39;</span>,</span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a>                xticklabels<span class="op">=</span>labels, yticklabels<span class="op">=</span>labels)</span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Confusion Matrix&quot;</span>)</span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;True Label&quot;</span>)</span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Predicted Label&quot;</span>)</span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;confusion_matrix_eval.png&quot;</span>)</span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;confusion_matrix_eval.png&quot;</span>)</span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 4. Cohen’s Kappa ===</span></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>    kappa <span class="op">=</span> cohen_kappa_score(y_true, y_pred)</span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 5. Full Classification Report ===</span></span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>    report <span class="op">=</span> classification_report(y_true, y_pred, target_names<span class="op">=</span>labels, output_dict<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> report[<span class="st">&#39;accuracy&#39;</span>]</span>
<span id="cb65-81"><a href="#cb65-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-82"><a href="#cb65-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === LOG ALL METRICS ===</span></span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;test_accuracy&quot;</span>, acc)</span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;roc_auc&quot;</span>, roc_auc)</span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;pr_auc&quot;</span>, pr_auc)</span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;sensitivity_infected&quot;</span>, sensitivity)</span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;specificity_healthy&quot;</span>, specificity)</span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;precision_infected&quot;</span>, precision_pos)</span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;f1_infected&quot;</span>, f1_pos)</span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;cohen_kappa&quot;</span>, kappa)</span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === PRINT SUMMARY ===</span></span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;FULL METRIC SUITE&quot;</span>)</span>
<span id="cb65-94"><a href="#cb65-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Accuracy:          </span><span class="sc">{</span>acc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-95"><a href="#cb65-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;ROC-AUC:           </span><span class="sc">{</span>roc_auc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;PR-AUC (AP):       </span><span class="sc">{</span>pr_auc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Sensitivity (Inf): </span><span class="sc">{</span>sensitivity<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Specificity (Hlt): </span><span class="sc">{</span>specificity<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Precision (Inf):   </span><span class="sc">{</span>precision_pos<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;F1-Score (Inf):    </span><span class="sc">{</span>f1_pos<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Cohen&#39;s Kappa:     </span><span class="sc">{</span>kappa<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Confusion Matrix:&quot;</span>)</span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(cm)</span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">MLflow Run ID: </span><span class="sc">{</span>eval_run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<section id="2-full-error-analysis-code" class="cell markdown"
id="iTUUH9R3ziaP">
<h3>2. Full Error Analysis Code</h3>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904894,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733744,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="bGEc8XXozl_N">
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> load_model</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load best model</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> load_model(<span class="st">&quot;final_best_model.h5&quot;</span>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Error_Analysis&quot;</span>) <span class="im">as</span> error_run:</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 1. Get predictions on test set ===</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    y_pred_prob <span class="op">=</span> best_model.predict(test_gen, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.argmax(y_pred_prob, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> test_gen.classes</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    filenames <span class="op">=</span> test_gen.filenames  <span class="co"># relative paths</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map filenames to full paths from test_df</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    path_map <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(test_df[<span class="st">&#39;image_path&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.split(<span class="st">&#39;/&#39;</span>)[<span class="op">-</span><span class="dv">1</span>]), test_df[<span class="st">&#39;image_path&#39;</span>]))</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    full_paths <span class="op">=</span> [path_map.get(f.split(<span class="st">&#39;/&#39;</span>)[<span class="op">-</span><span class="dv">1</span>], f) <span class="cf">for</span> f <span class="kw">in</span> filenames]</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 2. Find misclassified indices ===</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>    misclassified_idx <span class="op">=</span> np.where(y_pred <span class="op">!=</span> y_true)[<span class="dv">0</span>]</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Found </span><span class="sc">{</span><span class="bu">len</span>(misclassified_idx)<span class="sc">}</span><span class="ss"> misclassified images.&quot;</span>)</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 3. Plot Misclassified Images (2x3 Grid) ===</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    n_plot <span class="op">=</span> <span class="bu">min</span>(<span class="dv">6</span>, <span class="bu">len</span>(misclassified_idx))</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_plot <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>        fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> axes.ravel()</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_plot):</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> misclassified_idx[i]</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>            img_path <span class="op">=</span> full_paths[idx]</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>            true_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_true[idx]]</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>            pred_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_pred[idx]]</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>            confidence <span class="op">=</span> y_pred_prob[idx].<span class="bu">max</span>()</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Load and preprocess image</span></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> cv2.imread(img_path)</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>            img <span class="op">=</span> cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>            img_resized <span class="op">=</span> cv2.resize(img, (<span class="dv">224</span>, <span class="dv">224</span>))</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>            axes[i].imshow(img_resized)</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>            axes[i].set_title(<span class="ss">f&quot;True: </span><span class="sc">{</span>true_label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Pred: </span><span class="sc">{</span>pred_label<span class="sc">}</span><span class="ch">\n</span><span class="ss">Conf: </span><span class="sc">{</span>confidence<span class="sc">:.2f}</span><span class="ss">&quot;</span>,</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>                              fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">&#39;red&#39;</span> <span class="cf">if</span> true_label <span class="op">!=</span> pred_label <span class="cf">else</span> <span class="st">&#39;green&#39;</span>)</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>            axes[i].axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hide empty subplots</span></span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n_plot, <span class="dv">6</span>):</span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a>            axes[j].axis(<span class="st">&#39;off&#39;</span>)</span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>        plt.suptitle(<span class="st">&quot;Misclassified Images (Error Analysis)&quot;</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a>        plt.savefig(<span class="st">&quot;misclassified_grid.png&quot;</span>)</span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>        plt.close()</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="st">&quot;misclassified_grid.png&quot;</span>)</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;No misclassified images to display.&quot;</span>)</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 4. Brightness &amp; Contrast Analysis ===</span></span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>    brightness <span class="op">=</span> []</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>    contrast <span class="op">=</span> []</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a>    error_type <span class="op">=</span> []</span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(y_true)):</span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> full_paths[idx]</span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> cv2.imread(img_path, cv2.IMREAD_GRAYSCALE)</span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> cv2.resize(img, (<span class="dv">224</span>, <span class="dv">224</span>))</span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Brightness = mean pixel intensity</span></span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a>        bright <span class="op">=</span> np.mean(img)</span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Contrast = standard deviation</span></span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true" tabindex="-1"></a>        contr <span class="op">=</span> np.std(img)</span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a>        true_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_true[idx]]</span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a>        pred_label <span class="op">=</span> <span class="bu">list</span>(test_gen.class_indices.keys())[y_pred[idx]]</span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a>        brightness.append(bright)</span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a>        contrast.append(contr)</span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a>        error_type.append(<span class="st">&quot;Correct&quot;</span> <span class="cf">if</span> true_label <span class="op">==</span> pred_label <span class="cf">else</span> <span class="st">&quot;Misclassified&quot;</span>)</span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame</span></span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true" tabindex="-1"></a>    error_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;brightness&#39;</span>: brightness,</span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;contrast&#39;</span>: contrast,</span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;error&#39;</span>: error_type</span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 5. Heatmap: Errors vs Brightness/Contrast ===</span></span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bin into 5x5 grid</span></span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a>    error_df[<span class="st">&#39;bright_bin&#39;</span>] <span class="op">=</span> pd.cut(error_df[<span class="st">&#39;brightness&#39;</span>], bins<span class="op">=</span><span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a>    error_df[<span class="st">&#39;contrast_bin&#39;</span>] <span class="op">=</span> pd.cut(error_df[<span class="st">&#39;contrast&#39;</span>], bins<span class="op">=</span><span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count errors per bin</span></span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a>    heatmap_data <span class="op">=</span> error_df[error_df[<span class="st">&#39;error&#39;</span>] <span class="op">==</span> <span class="st">&#39;Misclassified&#39;</span>] <span class="op">\</span></span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">&#39;bright_bin&#39;</span>, <span class="st">&#39;contrast_bin&#39;</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(heatmap_data, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">&#39;d&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;Reds&#39;</span>, cbar_kws<span class="op">=</span>{<span class="st">&#39;label&#39;</span>: <span class="st">&#39;Misclassification Count&#39;</span>})</span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">&quot;Misclassifications by Brightness &amp; Contrast&quot;</span>)</span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Contrast Bin (Low to High)&quot;</span>)</span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Brightness Bin (Low to High)&quot;</span>)</span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">&quot;error_heatmap_brightness_contrast.png&quot;</span>)</span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-113"><a href="#cb66-113" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;error_heatmap_brightness_contrast.png&quot;</span>)</span>
<span id="cb66-114"><a href="#cb66-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === 6. Save error summary ===</span></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a>    total_errors <span class="op">=</span> <span class="bu">len</span>(misclassified_idx)</span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a>    error_rate <span class="op">=</span> total_errors <span class="op">/</span> <span class="bu">len</span>(y_true)</span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;misclassification_count&quot;</span>, total_errors)</span>
<span id="cb66-119"><a href="#cb66-119" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;error_rate&quot;</span>, error_rate)</span>
<span id="cb66-120"><a href="#cb66-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-121"><a href="#cb66-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: save error_df</span></span>
<span id="cb66-122"><a href="#cb66-122" aria-hidden="true" tabindex="-1"></a>    error_df.to_csv(<span class="st">&quot;error_analysis_data.csv&quot;</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb66-123"><a href="#cb66-123" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;error_analysis_data.csv&quot;</span>)</span>
<span id="cb66-124"><a href="#cb66-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-125"><a href="#cb66-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Error Analysis Complete:&quot;</span>)</span>
<span id="cb66-126"><a href="#cb66-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • Misclassified: </span><span class="sc">{</span>total_errors<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(y_true)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>error_rate<span class="sc">:.2%}</span><span class="ss">)&quot;</span>)</span>
<span id="cb66-127"><a href="#cb66-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • Grid plot: misclassified_grid.png&quot;</span>)</span>
<span id="cb66-128"><a href="#cb66-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • Heatmap: error_heatmap_brightness_contrast.png&quot;</span>)</span>
<span id="cb66-129"><a href="#cb66-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;  • MLflow Run ID: </span><span class="sc">{</span>error_run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell markdown" id="vT_tWRy6zufz">
<p>MLflow UI</p>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904895,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733745,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="reWMcXd9zwxN">
<div class="sourceCode" id="cb67"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>get_ipython().system_raw(<span class="st">&quot;mlflow ui --port 5000 &amp;&quot;</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;MLflow UI:&quot;</span>, ngrok.<span class="ex">connect</span>(<span class="dv">5000</span>))</span></code></pre></div>
</div>
<div class="cell markdown" id="IkuIjYXV0DdN">
<p>Auto Generate Comparison table</p>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904896,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733747,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="xE_66rve0HcP">
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow client</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> mlflow.tracking.MlflowClient()</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co"># === 1. Get all runs from your project ===</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>experiment_name <span class="op">=</span> <span class="st">&quot;Default&quot;</span>  <span class="co"># Change if you set a custom name</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    exp <span class="op">=</span> client.get_experiment_by_name(experiment_name)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    experiment_id <span class="op">=</span> exp.experiment_id</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    experiment_id <span class="op">=</span> <span class="st">&quot;0&quot;</span>  <span class="co"># default</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>runs <span class="op">=</span> client.search_runs(</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    experiment_ids<span class="op">=</span>[experiment_id],</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    filter_string<span class="op">=</span><span class="st">&quot;&quot;</span>,</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    run_view_type<span class="op">=</span>mlflow.entities.ViewType.ACTIVE_ONLY</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a><span class="co"># === 2. Extract data ===</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> []</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> run <span class="kw">in</span> runs:</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> run.data.params</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> run.data.metrics</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only include runs with test evaluation</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;test_accuracy&#39;</span> <span class="kw">not</span> <span class="kw">in</span> metrics:</span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>    data.append({</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Model ID&#39;</span>: run.info.run_id[:<span class="dv">8</span>],</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Run Name&#39;</span>: run.data.tags.get(<span class="st">&#39;mlflow.runName&#39;</span>, <span class="st">&#39;unnamed&#39;</span>),</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Learning Rate&#39;</span>: <span class="bu">float</span>(params.get(<span class="st">&#39;learning_rate&#39;</span>, params.get(<span class="st">&#39;lr&#39;</span>, <span class="dv">0</span>))),</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Batch Size&#39;</span>: <span class="bu">int</span>(params.get(<span class="st">&#39;batch_size&#39;</span>, <span class="dv">0</span>)),</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Dropout&#39;</span>: <span class="bu">float</span>(params.get(<span class="st">&#39;dropout&#39;</span>, <span class="dv">0</span>)),</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Val Accuracy&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;val_accuracy&#39;</span>, metrics.get(<span class="st">&#39;best_val_accuracy&#39;</span>, <span class="dv">0</span>)), <span class="dv">4</span>),</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Test Accuracy&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;test_accuracy&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;ROC-AUC&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;roc_auc&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;PR-AUC&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;pr_auc&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Kappa&#39;</span>: <span class="bu">round</span>(metrics.get(<span class="st">&#39;cohen_kappa&#39;</span>, <span class="dv">0</span>), <span class="dv">4</span>),</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Params (K)&#39;</span>: <span class="bu">round</span>(<span class="bu">int</span>(params.get(<span class="st">&#39;trainable_params&#39;</span>, <span class="dv">94000</span>)) <span class="op">/</span> <span class="dv">1000</span>, <span class="dv">1</span>),</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Date&#39;</span>: datetime.fromtimestamp(run.info.start_time <span class="op">/</span> <span class="dv">1000</span>).strftime(<span class="st">&#39;%m-</span><span class="sc">%d</span><span class="st"> %H:%M&#39;</span>)</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a><span class="co"># === 3. Add your baseline (prototype) model from notebook ===</span></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>data.append({</span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Model ID&#39;</span>: <span class="st">&#39;baseline&#39;</span>,</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Run Name&#39;</span>: <span class="st">&#39;Prototype (128×128)&#39;</span>,</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Learning Rate&#39;</span>: <span class="fl">0.001</span>,</span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Batch Size&#39;</span>: <span class="dv">32</span>,</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Dropout&#39;</span>: <span class="fl">0.0</span>,</span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Val Accuracy&#39;</span>: <span class="fl">0.9300</span>,  <span class="co"># from your training log</span></span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Test Accuracy&#39;</span>: <span class="fl">0.9307</span>,  <span class="co"># from evaluation</span></span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;ROC-AUC&#39;</span>: <span class="fl">0.987</span>,        <span class="co"># from classification report</span></span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;PR-AUC&#39;</span>: <span class="fl">0.987</span>,</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Kappa&#39;</span>: <span class="fl">0.861</span>,          <span class="co"># estimated from report</span></span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Params (K)&#39;</span>: <span class="fl">94.0</span>,</span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Date&#39;</span>: <span class="st">&#39;10-28 14:00&#39;</span></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort by Test Accuracy</span></span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sort_values(<span class="st">&#39;Test Accuracy&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a><span class="co"># === 4. Create Markdown Table ===</span></span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_comparison_md(df):</span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> <span class="st">&quot;&quot;&quot;# Model Comparison Table</span><span class="ch">\n\n</span><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a>    md <span class="op">+=</span> <span class="st">&quot;&gt; **Week 9 Deliverable** – Comparison of all trained models</span><span class="ch">\n\n</span><span class="st">&quot;</span></span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a>    md <span class="op">+=</span> df.to_markdown(index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a>    md <span class="op">+=</span> <span class="st">&quot;</span><span class="ch">\n\n</span><span class="st">---</span><span class="ch">\n</span><span class="st">*Best model highlighted in bold*</span><span class="ch">\n</span><span class="st">&quot;</span></span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> md</span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a>comparison_md <span class="op">=</span> make_comparison_md(df)</span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Print</span></span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(comparison_md)</span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Save</span></span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;comparison_table.md&quot;</span>, <span class="st">&quot;w&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>    f.write(comparison_md)</span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a><span class="co"># === 5. Log to MLflow ===</span></span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">&quot;Model_Comparison_Table&quot;</span>) <span class="im">as</span> compare_run:</span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;comparison_table.md&quot;</span>)</span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a>    mlflow.log_text(comparison_md, <span class="st">&quot;comparison_table.txt&quot;</span>)</span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;n_models_compared&quot;</span>, <span class="bu">len</span>(df))</span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Comparison table logged! Run ID: </span><span class="sc">{</span>compare_run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<section id="model-comparison-summary" class="cell markdown"
id="26e099f8">
<h1>Model Comparison Summary</h1>
<p>This table compares the performance of different models trained on
the Conjunctivitis Dataset, based on metrics logged to MLflow.</p>
<table>
<colgroup>
<col style="width: 8%" />
<col style="width: 43%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Column</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">What it tells you</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Model ID</strong></td>
<td style="text-align: left;">A unique identifier for the MLflow run (or
a label like 'baseline').</td>
<td style="text-align: left;">Helps you distinguish between different
experiments.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Run Name</strong></td>
<td style="text-align: left;">A human-readable name given to the MLflow
run.</td>
<td style="text-align: left;">Provides context for the experiment (e.g.,
'Prototype', 'Hyperparameter_Search').</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Learning Rate</strong></td>
<td style="text-align: left;">The learning rate used during
training.</td>
<td style="text-align: left;">A key hyperparameter affecting how quickly
the model learns.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Batch Size</strong></td>
<td style="text-align: left;">The number of samples processed before
updating the model weights.</td>
<td style="text-align: left;">Another key hyperparameter affecting
training stability and speed.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Dropout</strong></td>
<td style="text-align: left;">The dropout rate used in the model (a
regularization technique).</td>
<td style="text-align: left;">Helps prevent overfitting.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Val Accuracy</strong></td>
<td style="text-align: left;">The accuracy of the model on the
validation set during training.</td>
<td style="text-align: left;">Indicates how well the model generalizes
to unseen data during training.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Test Accuracy</strong></td>
<td style="text-align: left;">The accuracy of the model on the held-out
test set after training.</td>
<td style="text-align: left;">The most important metric for evaluating
the final performance on truly unseen data.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>ROC-AUC</strong></td>
<td style="text-align: left;">Area Under the Receiver Operating
Characteristic curve.</td>
<td style="text-align: left;">Measures the model's ability to
distinguish between classes (higher is better).</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>PR-AUC</strong></td>
<td style="text-align: left;">Area Under the Precision-Recall curve
(also called Average Precision - AP).</td>
<td style="text-align: left;">Useful for imbalanced datasets; measures
the trade-off between precision and recall.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Kappa</strong></td>
<td style="text-align: left;">Cohen's Kappa Score.</td>
<td style="text-align: left;">Measures the agreement between the
predicted and true labels, correcting for chance agreement.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Params (K)</strong></td>
<td style="text-align: left;">The number of trainable parameters in the
model (in thousands).</td>
<td style="text-align: left;">Indicates the model's complexity.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Date</strong></td>
<td style="text-align: left;">The date and time the experiment run
started.</td>
<td style="text-align: left;">Helps track the timeline of your
experiments.</td>
</tr>
</tbody>
</table>
<h2 id="best-model-performance">Best Model Performance</h2>
<p>Based on the <code>Test Accuracy</code> metric in the comparison
table, the best performing model was the <strong>Prototype
(128x128)</strong> model, identified with
<code>Model ID: baseline</code>.</p>
<p>Its key performance metrics on the test set were:</p>
<ul>
<li><strong>Test Accuracy:</strong> 0.9307</li>
<li><strong>ROC-AUC:</strong> 0.9870</li>
<li><strong>PR-AUC (AP):</strong> 0.9870</li>
<li><strong>Cohen's Kappa:</strong> 0.8610</li>
</ul>
<p>This indicates that the initial prototype model achieved strong
results in classifying healthy and infected eyes on the test dataset.
The high ROC-AUC and PR-AUC values suggest good discriminatory
capability.</p>
<p>It's worth noting that the hyperparameter search runs logged to
MLflow did not achieve comparable test performance in this table.
Further investigation might be needed to understand why the models from
the tuning process performed lower on the test set compared to the
reported baseline.</p>
</section>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904897,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733748,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="V1eZqCc3P-KZ">
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Download latest version</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;ibrahimfateen/wound-classification&quot;</span>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Path to dataset files:&quot;</span>, path)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904898,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733749,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="p2L9c0XeRQa3">
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Checking the output</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(os.listdir(path))</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904898,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733749,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="YbnOEcESRSOY">
<div class="sourceCode" id="cb71"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># New cell: Load and process wound dataset</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> kagglehub <span class="co"># Ensure kagglehub is imported</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Download wound dataset</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>path_wound <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;ibrahimfateen/wound-classification&quot;</span>)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Path to wound dataset files:&quot;</span>, path_wound)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Path object</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>dataset_wound_root <span class="op">=</span> Path(path_wound)</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Find image files recursively (include png)</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>img_files_wound <span class="op">=</span> (</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_wound_root.rglob(<span class="st">&quot;*.jpg&quot;</span>)) <span class="op">+</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_wound_root.rglob(<span class="st">&quot;*.jpeg&quot;</span>)) <span class="op">+</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(dataset_wound_root.rglob(<span class="st">&quot;*.png&quot;</span>)) <span class="co"># Added .png</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Found </span><span class="sc">{</span><span class="bu">len</span>(img_files_wound)<span class="sc">}</span><span class="ss"> wound image files under </span><span class="sc">{</span>dataset_wound_root<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Build DataFrame for wound dataset</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>rows_wound <span class="op">=</span> []</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> img_files_wound:</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Infer label from parent directory name</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>    label <span class="op">=</span> p.parent.name</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>    rows_wound.append([<span class="bu">str</span>(p.resolve()), label])</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>df_wound <span class="op">=</span> pd.DataFrame(rows_wound, columns<span class="op">=</span>[<span class="st">&quot;image_path&quot;</span>, <span class="st">&quot;label&quot;</span>])</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a><span class="co"># SEED is defined in a previous cell</span></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>    SEED</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>    SEED <span class="op">=</span> <span class="dv">42</span> <span class="co"># Define SEED</span></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>df_wound <span class="op">=</span> df_wound.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span>SEED).reset_index(drop<span class="op">=</span><span class="va">True</span>)  <span class="co"># Shuffle</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Sample wound rows:&quot;</span>)</span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a>display(df_wound.head())</span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Unique wound labels found:&quot;</span>, df_wound[<span class="st">&#39;label&#39;</span>].unique())</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904899,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733750,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="16plykHdSDCy">
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding The Rash Dataset</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and process rash dataset</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>path_rash <span class="op">=</span> kagglehub.dataset_download(<span class="st">&quot;kmader/skin-cancer-mnist-ham10000&quot;</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Path to rash dataset files:&quot;</span>, path_rash)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to Path object</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>dataset_rash_root <span class="op">=</span> Path(path_rash)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Find image files recursively</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>img_files_rash <span class="op">=</span> <span class="bu">list</span>(dataset_rash_root.rglob(<span class="st">&quot;*.jpg&quot;</span>)) <span class="op">+</span> <span class="bu">list</span>(dataset_rash_root.rglob(<span class="st">&quot;*.jpeg&quot;</span>)) <span class="op">+</span> <span class="bu">list</span>(dataset_rash_root.rglob(<span class="st">&quot;*.png&quot;</span>))</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Found </span><span class="sc">{</span><span class="bu">len</span>(img_files_rash)<span class="sc">}</span><span class="ss"> rash image files under </span><span class="sc">{</span>dataset_rash_root<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Build DataFrame for rash dataset</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>rows_rash <span class="op">=</span> []</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> img_files_rash:</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    label <span class="op">=</span> p.parent.name  <span class="co"># Assume subfolders indicate class (e.g., &#39;melanoma&#39;, &#39;nevus&#39;)</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    rows_rash.append([<span class="bu">str</span>(p.resolve()), label])</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>df_rash <span class="op">=</span> pd.DataFrame(rows_rash, columns<span class="op">=</span>[<span class="st">&quot;image_path&quot;</span>, <span class="st">&quot;label&quot;</span>])</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>df_rash <span class="op">=</span> df_rash.sample(frac<span class="op">=</span><span class="dv">1</span>, random_state<span class="op">=</span>SEED).reset_index(drop<span class="op">=</span><span class="va">True</span>)  <span class="co"># Shuffle</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Sample rash rows:&quot;</span>)</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>display(df_rash.head())</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Unique rash labels found:&quot;</span>, df_rash[<span class="st">&#39;label&#39;</span>].unique())</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904898,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733750,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="5VFwuq0_Uca_">
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all datasets</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>df_combined <span class="op">=</span> pd.concat([df, df_rash, df_wound], ignore_index<span class="op">=</span><span class="va">True</span>)  <span class="co"># Assume &#39;df&#39; is the conjunctivitis DataFrame</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Combined dataset size: </span><span class="sc">{</span><span class="bu">len</span>(df_combined)<span class="sc">}</span><span class="ss"> images&quot;</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Unique labels in combined dataset:&quot;</span>, df_combined[<span class="st">&#39;label&#39;</span>].unique())</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904899,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733751,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="ZBZZOW7NUzXs">
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Setting up Streamlit</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q streamlit ngrok</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904900,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733752,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="QG0x9iAwVAJl">
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Verifying installation</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> streamlit</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Streamlit version:&quot;</span>, streamlit.__version__)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904900,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733752,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="bhNuwHBxVm1K">
<div class="sourceCode" id="cb76"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile app.py</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the pre-trained conjunctivitis model (adjust path as needed)</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;/content/drive/MyDrive/Colab Notebooks/conjunctivitis_cnn_model.h5&#39;</span>)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to preprocess image (match Phase 03 preprocessing)</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image):</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> image.resize((<span class="dv">128</span>, <span class="dv">128</span>))  <span class="co"># Resize to 128x128 as in Phase 02/03</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.array(img) <span class="op">/</span> <span class="fl">255.0</span>  <span class="co"># Normalize to [0,1]</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.expand_dims(img_array, axis<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Add batch dimension</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_array</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to predict and generate reports (initially for conjunctivitis)</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_image(img):</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    processed_img <span class="op">=</span> preprocess_image(img)</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> model.predict(processed_img)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [<span class="st">&#39;healthy_eye&#39;</span>, <span class="st">&#39;infected_eye&#39;</span>]  <span class="co"># Update for multi-class later</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    predicted_class <span class="op">=</span> class_names[<span class="bu">int</span>(prediction[<span class="dv">0</span>][<span class="dv">0</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>)]</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    confidence <span class="op">=</span> prediction[<span class="dv">0</span>][<span class="dv">0</span>] <span class="cf">if</span> predicted_class <span class="op">==</span> <span class="st">&#39;infected_eye&#39;</span> <span class="cf">else</span> <span class="dv">1</span> <span class="op">-</span> prediction[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate outputs</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>    patient_summary <span class="op">=</span> <span class="ss">f&quot;This eye appears </span><span class="sc">{</span>predicted_class<span class="sc">}</span><span class="ss">. &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">&quot;Consult a doctor if symptoms persist.&quot;</span> <span class="cf">if</span> predicted_class <span class="op">==</span> <span class="st">&#39;infected_eye&#39;</span> <span class="cf">else</span> <span class="st">&quot;No urgent action needed.&quot;</span>)</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    clinician_report <span class="op">=</span> <span class="ss">f&quot;Eye classification: </span><span class="sc">{</span>predicted_class<span class="sc">}</span><span class="ss"> (Confidence: </span><span class="sc">{</span>confidence<span class="sc">:.2f}</span><span class="ss">). &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Recommend urgent review if symptoms worsen.&quot;</span> <span class="cf">if</span> predicted_class <span class="op">==</span> <span class="st">&#39;infected_eye&#39;</span> <span class="cf">else</span> <span class="st">&quot;Routine check suggested.&quot;</span>)</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patient_summary, clinician_report</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Streamlit UI</span></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>st.title(<span class="st">&quot;TriagePal: AI Pre-Analysis Tool&quot;</span>)</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>st.write(<span class="st">&quot;Upload an eye image and describe symptoms to get a preliminary assessment.&quot;</span>)</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a><span class="co"># File uploader for image</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>uploaded_image <span class="op">=</span> st.file_uploader(<span class="st">&quot;Upload an eye image (jpg/png)&quot;</span>, <span class="bu">type</span><span class="op">=</span>[<span class="st">&quot;jpg&quot;</span>, <span class="st">&quot;png&quot;</span>])</span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>symptoms <span class="op">=</span> st.text_area(<span class="st">&quot;Describe symptoms and conditions (e.g., redness, itch, migraines)&quot;</span>)</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> st.button(<span class="st">&quot;Analyze&quot;</span>):</span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uploaded_image <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Display uploaded image</span></span>
<span id="cb76-44"><a href="#cb76-44" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> Image.<span class="bu">open</span>(uploaded_image)</span>
<span id="cb76-45"><a href="#cb76-45" aria-hidden="true" tabindex="-1"></a>        st.image(img, caption<span class="op">=</span><span class="st">&quot;Uploaded Image&quot;</span>, width<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb76-46"><a href="#cb76-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-47"><a href="#cb76-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Analyze image</span></span>
<span id="cb76-48"><a href="#cb76-48" aria-hidden="true" tabindex="-1"></a>        patient_summary, clinician_report <span class="op">=</span> analyze_image(img)</span>
<span id="cb76-49"><a href="#cb76-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-50"><a href="#cb76-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Display results</span></span>
<span id="cb76-51"><a href="#cb76-51" aria-hidden="true" tabindex="-1"></a>        st.subheader(<span class="st">&quot;Patient Summary&quot;</span>)</span>
<span id="cb76-52"><a href="#cb76-52" aria-hidden="true" tabindex="-1"></a>        st.write(patient_summary)</span>
<span id="cb76-53"><a href="#cb76-53" aria-hidden="true" tabindex="-1"></a>        st.subheader(<span class="st">&quot;Clinician Report&quot;</span>)</span>
<span id="cb76-54"><a href="#cb76-54" aria-hidden="true" tabindex="-1"></a>        st.write(clinician_report)</span>
<span id="cb76-55"><a href="#cb76-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb76-56"><a href="#cb76-56" aria-hidden="true" tabindex="-1"></a>        st.warning(<span class="st">&quot;Please upload an image to proceed.&quot;</span>)</span>
<span id="cb76-57"><a href="#cb76-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-58"><a href="#cb76-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Disclaimer</span></span>
<span id="cb76-59"><a href="#cb76-59" aria-hidden="true" tabindex="-1"></a>st.warning(<span class="st">&quot;This is not a medical diagnosis. Consult a healthcare professional for accurate advice.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904901,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733753,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="cpOtYOgQbKfE">
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">&quot;pkill ngrok&quot;</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Existing ngrok processes killed.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904900,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733753,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="uO6M_oLCbUog">
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Check ngrok configure file</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check common config paths</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>config_paths <span class="op">=</span> [</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    os.path.expanduser(<span class="st">&quot;~/.config/ngrok/ngrok.yml&quot;</span>),</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    os.path.expanduser(<span class="st">&quot;~/.ngrok2/ngrok.yml&quot;</span>)</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> path <span class="kw">in</span> config_paths:</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(path):</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Found config file: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>        shutil.rmtree(os.path.dirname(path)) <span class="cf">if</span> <span class="st">&quot;ngrok2&quot;</span> <span class="kw">in</span> path <span class="cf">else</span> os.remove(path)</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Removed: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;No config at: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Config cleanup complete.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904901,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733754,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="q8Agy3C0bkGd">
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Uninstall and Reinstall pyngrok</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip uninstall pyngrok -y</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install pyngrok</span></span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904901,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733754,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="fu3GtlZxiYrV">
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Kill any existing ngrok or streamlit processes</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">&quot;pkill ngrok&quot;</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">&quot;pkill -f streamlit&quot;</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Existing processes killed.&quot;</span>)</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove old ngrok config files (if any)</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>config_paths <span class="op">=</span> [</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    os.path.expanduser(<span class="st">&quot;~/.config/ngrok/ngrok.yml&quot;</span>),</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    os.path.expanduser(<span class="st">&quot;~/.ngrok2/ngrok.yml&quot;</span>)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> path <span class="kw">in</span> config_paths:</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(path):</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Found config file: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        shutil.rmtree(os.path.dirname(path)) <span class="cf">if</span> <span class="st">&quot;ngrok2&quot;</span> <span class="kw">in</span> path <span class="cf">else</span> os.remove(path)</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Removed: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;No config at: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Cleanup complete.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904915,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733768,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="02Y7tdrEieo6">
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install or upgrade required packages</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q <span class="op">--</span>upgrade streamlit pyngrok tensorflow</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify versions</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> streamlit</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Streamlit version:&quot;</span>, streamlit.__version__)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;TensorFlow version:&quot;</span>, tf.__version__)</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Pyngrok version:&quot;</span>, ngrok.__version__)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904915,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733769,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="WeHOjJwhijDM">
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your ngrok authtoken</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>ngrok.set_auth_token(<span class="st">&quot;34kPpTGbA8SPniLPhSFXRl3VjEE_4pT93d7LLqCaiq4j8Ub9m&quot;</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Authtoken set.&quot;</span>)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure all existing ngrok tunnels are killed before starting a new one</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co"># This helps clear the &#39;endpoint already online&#39; error</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>ngrok.kill()</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Existing ngrok processes killed by pyngrok.kill().&quot;</span>)</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Start Streamlit in the background</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>streamlit run <span class="op">/</span>content<span class="op">/</span>app.py <span class="op">&amp;&gt;/</span>content<span class="op">/</span>logs.txt <span class="op">&amp;</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait for Streamlit to start</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">5</span>)</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect ngrok tunnel with correct addr syntax</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>public_url <span class="op">=</span> ngrok.<span class="ex">connect</span>(addr<span class="op">=</span><span class="st">&quot;localhost:8501&quot;</span>)</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Streamlit app running at:&quot;</span>, public_url)</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Keep tunnel info for cleanup</span></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>tunnel_url <span class="op">=</span> public_url</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904922,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733776,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="HjEyWaC8ijho">
<div class="sourceCode" id="cb83"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Setting up backend</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q tensorflow streamlit transformers scikit<span class="op">-</span>learn pandas numpy mlflow keras<span class="op">-</span>tuner</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904923,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733777,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="UJ8jNFDGYOsQ">
<div class="sourceCode" id="cb84"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> pipeline</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Environment ready.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904923,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733777,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="bW31YrMdYWj6">
<div class="sourceCode" id="cb85"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Computer Vision Component: Extend the CNN for Multi-Class Load Datasets: Reuse the DataFrames from Step 2 (df for conjunctivitis, df_rash, df_wound)</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>df_combined <span class="op">=</span> pd.concat([df, df_rash, df_wound], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Combined dataset size: </span><span class="sc">{</span><span class="bu">len</span>(df_combined)<span class="sc">}</span><span class="ss"> images&quot;</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Unique labels:&quot;</span>, df_combined[<span class="st">&#39;label&#39;</span>].unique())</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904923,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733778,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="OQc3rSbcYhpV">
<div class="sourceCode" id="cb86"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Preprocess Data</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd <span class="co"># Ensure pandas is imported</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove rows with NaN values in the &#39;label&#39; column</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>df_combined_cleaned <span class="op">=</span> df_combined.dropna(subset<span class="op">=</span>[<span class="st">&#39;label&#39;</span>]).copy() <span class="co"># Create a copy to avoid SettingWithCopyWarning</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>datagen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    rotation_range<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    width_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    height_shift_range<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    horizontal_flip<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    validation_split<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into train/validation</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the cleaned DataFrame for splitting</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>train_df_cleaned, val_df_cleaned <span class="op">=</span> train_test_split(</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    df_combined_cleaned,</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>    test_size<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>    stratify<span class="op">=</span>df_combined_cleaned[<span class="st">&#39;label&#39;</span>] <span class="co"># Stratify on the cleaned label column</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the cleaned DataFrames for generators</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>train_generator <span class="op">=</span> datagen.flow_from_dataframe(</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>    train_df_cleaned, <span class="co"># Use cleaned train_df</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>    x_col<span class="op">=</span><span class="st">&quot;image_path&quot;</span>,</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>    y_col<span class="op">=</span><span class="st">&quot;label&quot;</span>,</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>    target_size<span class="op">=</span>(<span class="dv">128</span>, <span class="dv">128</span>),</span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span><span class="st">&#39;training&#39;</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>val_generator <span class="op">=</span> datagen.flow_from_dataframe(</span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>    val_df_cleaned, <span class="co"># Use cleaned val_df</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>    x_col<span class="op">=</span><span class="st">&quot;image_path&quot;</span>,</span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>    y_col<span class="op">=</span><span class="st">&quot;label&quot;</span>,</span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>    target_size<span class="op">=</span>(<span class="dv">128</span>, <span class="dv">128</span>),</span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span><span class="st">&#39;validation&#39;</span></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of images after removing NaNs: </span><span class="sc">{</span><span class="bu">len</span>(df_combined_cleaned)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Train images: </span><span class="sc">{</span><span class="bu">len</span>(train_df_cleaned)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Validation images: </span><span class="sc">{</span><span class="bu">len</span>(val_df_cleaned)<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904924,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733779,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="Nxo-ErwOY3dg">
<div class="sourceCode" id="cb87"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Update Model Architecture: Modify the Phase 03 CNN for multi-class</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, Dropout, GlobalAveragePooling2D, Dense, BatchNormalization</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure train_generator is available from the previous cell&#39;s execution</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co"># num_classes = len(df_combined[&#39;label&#39;].unique()) # This was incorrect</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="bu">len</span>(train_generator.class_indices) <span class="co"># Get the number of classes from the generator</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Sequential([</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">32</span>, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, input_shape<span class="op">=</span>(<span class="dv">128</span>, <span class="dv">128</span>, <span class="dv">3</span>)),</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    BatchNormalization(),</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D((<span class="dv">2</span>, <span class="dv">2</span>)),</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">64</span>, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    BatchNormalization(),</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    MaxPooling2D((<span class="dv">2</span>, <span class="dv">2</span>)),</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    Conv2D(<span class="dv">128</span>, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>    BatchNormalization(),</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    GlobalAveragePooling2D(),</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    Dropout(<span class="fl">0.35</span>),</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>    Dense(<span class="dv">64</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>),</span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>    Dropout(<span class="fl">0.2</span>),</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>    Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)  <span class="co"># Softmax for multi-class</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>, loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>model.summary()</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904924,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733779,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="hAUkI9BKY_us">
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Train the model</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure train_generator and val_generator are available from the previous cell</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Training with </span><span class="sc">{</span><span class="bu">len</span>(train_generator.class_indices)<span class="sc">}</span><span class="ss"> classes.&quot;</span>)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Validating with </span><span class="sc">{</span><span class="bu">len</span>(val_generator.class_indices)<span class="sc">}</span><span class="ss"> classes.&quot;</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    train_generator,</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    validation_data<span class="op">=</span>val_generator,</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    callbacks<span class="op">=</span>[tf.keras.callbacks.EarlyStopping(patience<span class="op">=</span><span class="dv">5</span>, restore_best_weights<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904925,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733780,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="8zBE5G69ZJ9I">
<div class="sourceCode" id="cb89"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Save the model</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>model.save(<span class="st">&#39;triagepal_multi_class_model.h5&#39;</span>)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Model saved as triagepal_multi_class_model.h5&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904934,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733789,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="MfEZuvKxGrNc">
<div class="sourceCode" id="cb90"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install tf<span class="op">-</span>keras</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904935,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733791,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="d1tezIi3ZaNY">
<div class="sourceCode" id="cb91"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">#NLP Component: Parse Symptoms Add a simple NLP pipeline to extract features from symptom text</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> pipeline(<span class="st">&quot;ner&quot;</span>, model<span class="op">=</span><span class="st">&quot;dslim/bert-base-NER&quot;</span>)  <span class="co"># Basic NER model</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_symptoms(text):</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> text:</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&quot;symptoms&quot;</span>: [], <span class="st">&quot;urgency&quot;</span>: <span class="dv">0</span>}</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    entities <span class="op">=</span> nlp(text)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    symptoms <span class="op">=</span> [ent[<span class="st">&#39;word&#39;</span>] <span class="cf">for</span> ent <span class="kw">in</span> entities <span class="cf">if</span> ent[<span class="st">&#39;entity&#39;</span>].startswith(<span class="st">&#39;B-&#39;</span>)]</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    urgency_score <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> sym <span class="kw">in</span> symptoms <span class="cf">if</span> sym.lower() <span class="kw">in</span> [<span class="st">&#39;redness&#39;</span>, <span class="st">&#39;swelling&#39;</span>, <span class="st">&#39;pain&#39;</span>])  <span class="co"># Simple weighting</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;symptoms&quot;</span>: symptoms, <span class="st">&quot;urgency&quot;</span>: <span class="bu">min</span>(urgency_score, <span class="dv">2</span>)}  <span class="co"># Cap at 2 for now</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Test it</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>sample_text <span class="op">=</span> <span class="st">&quot;Patient reports redness and swelling on arm.&quot;</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> parse_symptoms(sample_text)</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Extracted symptoms:&quot;</span>, result[<span class="st">&quot;symptoms&quot;</span>])</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Urgency score:&quot;</span>, result[<span class="st">&quot;urgency&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904936,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733792,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="DCn8eUaXZspC">
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Machine Learning</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Placeholder: Extract features from model predictions and symptoms</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_features(img_path, symptoms_text):</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(img_path).resize((<span class="dv">128</span>, <span class="dv">128</span>))</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.array(img) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.expand_dims(img_array, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    cv_pred <span class="op">=</span> model.predict(img_array)  <span class="co"># Multi-class probabilities</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    nlp_result <span class="op">=</span> parse_symptoms(symptoms_text)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.concatenate([cv_pred[<span class="dv">0</span>], [nlp_result[<span class="st">&quot;urgency&quot;</span>]]])</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample dataset (for demo; replace with real data later)</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>sample_paths <span class="op">=</span> df_combined[<span class="st">&#39;image_path&#39;</span>].sample(<span class="dv">100</span>).tolist()</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>sample_symptoms <span class="op">=</span> [<span class="st">&quot;redness and swelling&quot;</span> <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">&quot;no symptoms&quot;</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>)]</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.array([extract_features(p, s) <span class="cf">for</span> p, s <span class="kw">in</span> <span class="bu">zip</span>(sample_paths, sample_symptoms)])</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">100</span>)  <span class="co"># 0: low, 1: medium, 2: high (synthetic)</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Train Random Forest</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>rf.fit(X_train, y_train)</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> rf.score(X_test, y_test)</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Random Forest Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.2f}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904937,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733793,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="PqOLRFG0Z6F6">
<div class="sourceCode" id="cb93"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Integrate Backend Functions</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image <span class="co"># Import Image</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np <span class="co"># Import numpy</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Redefine preprocess_image function within the notebook scope</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image):</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> image.resize((<span class="dv">128</span>, <span class="dv">128</span>))  <span class="co"># Resize to 128x128 as used in training</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.array(img) <span class="op">/</span> <span class="fl">255.0</span>  <span class="co"># Normalize to [0,1]</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.expand_dims(img_array, axis<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Add batch dimension</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_array</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_input(img_path, symptoms_text):</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure model and parse_symptoms are available in this scope</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model is loaded in cell ISxmTghCyZi5</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># parse_symptoms is defined in cell d1tezIi3ZaNY</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>        model</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>        parse_symptoms</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>        rf <span class="co"># Ensure the random forest model is also available</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Error: Required variables (model, parse_symptoms, or rf) are not defined.&quot;</span>)</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(img_path).convert(<span class="st">&#39;RGB&#39;</span>) <span class="co"># Ensure image is in RGB</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>    cv_pred <span class="op">=</span> model.predict(preprocess_image(img))  <span class="co"># Multi-class probabilities</span></span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>    nlp_result <span class="op">=</span> parse_symptoms(symptoms_text)</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.concatenate([cv_pred[<span class="dv">0</span>], [nlp_result[<span class="st">&quot;urgency&quot;</span>]]])</span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure triage_score is within the valid range for indexing the urgency list</span></span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>    triage_score_raw <span class="op">=</span> rf.predict([features])[<span class="dv">0</span>]</span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>    triage_score <span class="op">=</span> <span class="bu">int</span>(np.clip(triage_score_raw, <span class="dv">0</span>, <span class="dv">2</span>)) <span class="co"># Clip to be safe</span></span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>    urgency <span class="op">=</span> [<span class="st">&quot;low&quot;</span>, <span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>][triage_score]</span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get predicted class from the CV model for the report</span></span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assuming you have access to the class names from your multi-class model training</span></span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If train_generator is available and has class_indices:</span></span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a>        train_generator</span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a>        class_names <span class="op">=</span> <span class="bu">list</span>(train_generator.class_indices.keys())</span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a>        cv_predicted_class <span class="op">=</span> class_names[cv_pred[<span class="dv">0</span>].argmax()]</span>
<span id="cb93-44"><a href="#cb93-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb93-45"><a href="#cb93-45" aria-hidden="true" tabindex="-1"></a>        cv_predicted_class <span class="op">=</span> <span class="st">&quot;Unknown Class&quot;</span> <span class="co"># Fallback if class names are not available</span></span>
<span id="cb93-46"><a href="#cb93-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-47"><a href="#cb93-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-48"><a href="#cb93-48" aria-hidden="true" tabindex="-1"></a>    patient_summary <span class="op">=</span> <span class="ss">f&quot;This condition appears to be </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> urgency based on image and symptoms. &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb93-49"><a href="#cb93-49" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">&quot;Consult a doctor soon.&quot;</span> <span class="cf">if</span> urgency <span class="kw">in</span> [<span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>] <span class="cf">else</span> <span class="st">&quot;Monitor and seek advice if worsening.&quot;</span>)</span>
<span id="cb93-50"><a href="#cb93-50" aria-hidden="true" tabindex="-1"></a>    clinician_report <span class="op">=</span> <span class="ss">f&quot;Triage score: </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> (CV Prediction: </span><span class="sc">{</span>cv_predicted_class<span class="sc">}</span><span class="ss">, Symptoms urgency: </span><span class="sc">{</span>nlp_result[<span class="st">&#39;urgency&#39;</span>]<span class="sc">}</span><span class="ss">). &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb93-51"><a href="#cb93-51" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Urgent review recommended.&quot;</span> <span class="cf">if</span> urgency <span class="op">==</span> <span class="st">&quot;high&quot;</span> <span class="cf">else</span> <span class="st">&quot;Follow-up suggested.&quot;</span>)</span>
<span id="cb93-52"><a href="#cb93-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patient_summary, clinician_report</span>
<span id="cb93-53"><a href="#cb93-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-54"><a href="#cb93-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb93-55"><a href="#cb93-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_combined is available and has image_path column</span></span>
<span id="cb93-56"><a href="#cb93-56" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb93-57"><a href="#cb93-57" aria-hidden="true" tabindex="-1"></a>    df_combined</span>
<span id="cb93-58"><a href="#cb93-58" aria-hidden="true" tabindex="-1"></a>    sample_path <span class="op">=</span> df_combined[<span class="st">&#39;image_path&#39;</span>].dropna().iloc[<span class="dv">0</span>] <span class="co"># Use a valid image path</span></span>
<span id="cb93-59"><a href="#cb93-59" aria-hidden="true" tabindex="-1"></a>    sample_text <span class="op">=</span> <span class="st">&quot;redness and pain&quot;</span></span>
<span id="cb93-60"><a href="#cb93-60" aria-hidden="true" tabindex="-1"></a>    summary, report <span class="op">=</span> process_input(sample_path, sample_text)</span>
<span id="cb93-61"><a href="#cb93-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> summary <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb93-62"><a href="#cb93-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Patient Summary:&quot;</span>, summary)</span>
<span id="cb93-63"><a href="#cb93-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Clinician Report:&quot;</span>, report)</span>
<span id="cb93-64"><a href="#cb93-64" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb93-65"><a href="#cb93-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Error: df_combined DataFrame is not defined. Cannot run test.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904937,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733793,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="oTdWcVpJaESZ">
<div class="sourceCode" id="cb94"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#log MFlow</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run():</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;num_classes&quot;</span>, num_classes)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;epochs&quot;</span>, <span class="dv">30</span>)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;rf_accuracy&quot;</span>, accuracy)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;triagepal_multi_class_model.h5&quot;</span>)</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Experiment logged with MLflow.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904937,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733794,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="b-Z5qTGXkfSk">
<div class="sourceCode" id="cb95"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Set Up SQLite in Colab</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;SQLite version:&quot;</span>, sqlite3.version)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904938,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733795,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="NH2eKqZ-kvJ-">
<div class="sourceCode" id="cb96"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Design the Database Schema</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to or create a database file</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;triagepal.db&#39;</span>)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create table</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">&#39;&#39;&#39;</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE TABLE IF NOT EXISTS triage_records (</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="st">    id INTEGER PRIMARY KEY AUTOINCREMENT,</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="st">    image_path TEXT,</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="st">    symptoms TEXT,</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="st">    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="st">    cv_class TEXT,</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="st">    confidence REAL,</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="st">    triage_score TEXT,</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="st">    patient_summary TEXT,</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="st">    clinician_report TEXT</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&#39;&#39;</span>)</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>conn.commit()</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Database and table created.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904938,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733795,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="dSNca4W2k9f4">
<div class="sourceCode" id="cb97"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Integrate Database with Backend</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image <span class="co"># Ensure Image is imported</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np <span class="co"># Ensure numpy is imported</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure model, preprocess_image, parse_symptoms, rf, cursor, and conn are available</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    model</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    preprocess_image</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    parse_symptoms</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    rf</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    cursor</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    conn</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Error: Required variables (model, preprocess_image, parse_symptoms, rf, cursor, conn) are not defined.&quot;</span>)</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># You might need to re-run previous cells to define these.</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For this fix, we assume they will be defined when the user runs the modified cell after previous cells.</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_input(img_path, symptoms_text, save_to_db<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure img_path is a string</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(img_path, <span class="bu">str</span>):</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Error: img_path must be a string, but received </span><span class="sc">{</span><span class="bu">type</span>(img_path)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span> <span class="co"># Return None for summary and report</span></span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the file exists before trying to open it</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(img_path):</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Error: Image file not found at </span><span class="sc">{</span>img_path<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span> <span class="co"># Return None for summary and report</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(img_path).convert(<span class="st">&#39;RGB&#39;</span>) <span class="co"># Ensure image is in RGB</span></span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>    cv_pred <span class="op">=</span> model.predict(preprocess_image(img))  <span class="co"># Multi-class probabilities</span></span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>    nlp_result <span class="op">=</span> parse_symptoms(symptoms_text)</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.concatenate([cv_pred[<span class="dv">0</span>], [nlp_result[<span class="st">&quot;urgency&quot;</span>]]])</span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure triage_score is within the valid range for indexing the urgency list</span></span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if rf prediction is an array and get the first element</span></span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>    triage_score_raw <span class="op">=</span> rf.predict([features])</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(triage_score_raw, np.ndarray) <span class="kw">and</span> triage_score_raw.size <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>         triage_score <span class="op">=</span> <span class="bu">int</span>(np.clip(triage_score_raw[<span class="dv">0</span>], <span class="dv">0</span>, <span class="dv">2</span>)) <span class="co"># Clip and convert to int</span></span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>         <span class="bu">print</span>(<span class="st">&quot;Error: Random Forest prediction failed or returned unexpected format.&quot;</span>)</span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>         triage_score <span class="op">=</span> <span class="dv">0</span> <span class="co"># Default to low urgency on error</span></span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>    urgency <span class="op">=</span> [<span class="st">&quot;low&quot;</span>, <span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>][triage_score]</span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get predicted class from the CV model for the report</span></span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assuming you have access to the class names from your multi-class model training</span></span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If train_generator is available and has class_indices:</span></span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>        train_generator</span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a>        class_names <span class="op">=</span> <span class="bu">list</span>(train_generator.class_indices.keys())</span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>        cv_predicted_class <span class="op">=</span> class_names[cv_pred[<span class="dv">0</span>].argmax()]</span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a>        cv_predicted_class <span class="op">=</span> <span class="st">&quot;Unknown Class&quot;</span> <span class="co"># Fallback if class names are not available</span></span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>    patient_summary <span class="op">=</span> <span class="ss">f&quot;This condition appears to be </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> urgency based on image and symptoms. &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">&quot;Consult a doctor soon.&quot;</span> <span class="cf">if</span> urgency <span class="kw">in</span> [<span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>] <span class="cf">else</span> <span class="st">&quot;Monitor and seek advice if worsening.&quot;</span>)</span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a>    clinician_report <span class="op">=</span> <span class="ss">f&quot;Triage score: </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> (CV Prediction: </span><span class="sc">{</span>cv_predicted_class<span class="sc">}</span><span class="ss">, Symptoms urgency: </span><span class="sc">{</span>nlp_result[<span class="st">&#39;urgency&#39;</span>]<span class="sc">}</span><span class="ss">). &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Urgent review recommended.&quot;</span> <span class="cf">if</span> urgency <span class="op">==</span> <span class="st">&quot;high&quot;</span> <span class="cf">else</span> <span class="st">&quot;Follow-up suggested.&quot;</span>)</span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_to_db:</span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a>            cursor.execute(<span class="st">&#39;&#39;&#39;</span></span>
<span id="cb97-69"><a href="#cb97-69" aria-hidden="true" tabindex="-1"></a><span class="st">            INSERT INTO triage_records (image_path, symptoms, cv_class, confidence, triage_score, patient_summary, clinician_report)</span></span>
<span id="cb97-70"><a href="#cb97-70" aria-hidden="true" tabindex="-1"></a><span class="st">            VALUES (?, ?, ?, ?, ?, ?, ?)</span></span>
<span id="cb97-71"><a href="#cb97-71" aria-hidden="true" tabindex="-1"></a><span class="st">            &#39;&#39;&#39;</span>, (img_path, symptoms_text, cv_predicted_class, <span class="bu">float</span>(cv_pred[<span class="dv">0</span>].<span class="bu">max</span>()), urgency, patient_summary, clinician_report))</span>
<span id="cb97-72"><a href="#cb97-72" aria-hidden="true" tabindex="-1"></a>            conn.commit()</span>
<span id="cb97-73"><a href="#cb97-73" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;Record inserted into database.&quot;</span>)</span>
<span id="cb97-74"><a href="#cb97-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb97-75"><a href="#cb97-75" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;Error saving to database: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb97-76"><a href="#cb97-76" aria-hidden="true" tabindex="-1"></a>            conn.rollback() <span class="co"># Rollback changes on error</span></span>
<span id="cb97-77"><a href="#cb97-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-78"><a href="#cb97-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-79"><a href="#cb97-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patient_summary, clinician_report</span>
<span id="cb97-80"><a href="#cb97-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-81"><a href="#cb97-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with database save</span></span>
<span id="cb97-82"><a href="#cb97-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_combined is available and has image_path column</span></span>
<span id="cb97-83"><a href="#cb97-83" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb97-84"><a href="#cb97-84" aria-hidden="true" tabindex="-1"></a>    df_combined</span>
<span id="cb97-85"><a href="#cb97-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Explicitly get a valid sample path from the cleaned DataFrame</span></span>
<span id="cb97-86"><a href="#cb97-86" aria-hidden="true" tabindex="-1"></a>    sample_path <span class="op">=</span> df_combined[<span class="st">&#39;image_path&#39;</span>].dropna().iloc[<span class="dv">0</span>]</span>
<span id="cb97-87"><a href="#cb97-87" aria-hidden="true" tabindex="-1"></a>    sample_text <span class="op">=</span> <span class="st">&quot;redness and pain&quot;</span></span>
<span id="cb97-88"><a href="#cb97-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Using sample image path for test: </span><span class="sc">{</span>sample_path<span class="sc">}</span><span class="ss">&quot;</span>) <span class="co"># Print path for verification</span></span>
<span id="cb97-89"><a href="#cb97-89" aria-hidden="true" tabindex="-1"></a>    summary, report <span class="op">=</span> process_input(sample_path, sample_text, save_to_db<span class="op">=</span><span class="va">True</span>) <span class="co"># Explicitly set save_to_db=True</span></span>
<span id="cb97-90"><a href="#cb97-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> summary <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb97-91"><a href="#cb97-91" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Patient Summary:&quot;</span>, summary)</span>
<span id="cb97-92"><a href="#cb97-92" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Clinician Report:&quot;</span>, report)</span>
<span id="cb97-93"><a href="#cb97-93" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb97-94"><a href="#cb97-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Error: df_combined DataFrame is not defined. Cannot run test.&quot;</span>)</span>
<span id="cb97-95"><a href="#cb97-95" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">IndexError</span>:</span>
<span id="cb97-96"><a href="#cb97-96" aria-hidden="true" tabindex="-1"></a>     <span class="bu">print</span>(<span class="st">&quot;Error: df_combined[&#39;image_path&#39;] is empty after dropping NaNs. Cannot run test.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904939,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733796,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="HbPeSv1NlWY7">
<div class="sourceCode" id="cb98"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Query the Database</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_records(limit<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    cursor.execute(<span class="st">&#39;SELECT * FROM triage_records ORDER BY timestamp DESC LIMIT ?&#39;</span>, (limit,))</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cursor.fetchall()</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display recent records</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> get_records()</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> record <span class="kw">in</span> records:</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;ID: </span><span class="sc">{</span>record[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">, Time: </span><span class="sc">{</span>record[<span class="dv">3</span>]<span class="sc">}</span><span class="ss">, Class: </span><span class="sc">{</span>record[<span class="dv">4</span>]<span class="sc">}</span><span class="ss">, Triage: </span><span class="sc">{</span>record[<span class="dv">6</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904939,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733796,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="sqgrJCuLllUG">
<div class="sourceCode" id="cb99"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Update the Streamlit App</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile app.py</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Database connection</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;triagepal.db&#39;</span>)</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Load model (assume defined globally or load here)</span></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;/content/drive/MyDrive/Colab Notebooks/triagepal_multi_class_model.h5&#39;</span>)</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestClassifier()  <span class="co"># Load trained RF (placeholder; load actual model)</span></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess function (from Step 5)</span></span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image):</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> image.resize((<span class="dv">128</span>, <span class="dv">128</span>))</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.array(img) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.expand_dims(img_array, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_array</span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a><span class="co"># NLP function (from Step 5)</span></span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_symptoms(text):</span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplified placeholder (use actual pipeline)</span></span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>    urgency <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> <span class="st">&quot;redness&quot;</span> <span class="kw">in</span> text.lower() <span class="kw">or</span> <span class="st">&quot;swelling&quot;</span> <span class="kw">in</span> text.lower() <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;symptoms&quot;</span>: text.split(), <span class="st">&quot;urgency&quot;</span>: urgency}</span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Process input function (from Step 5, adapted)</span></span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_input(img_path, symptoms_text, save_to_db<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a>    cv_pred <span class="op">=</span> model.predict(preprocess_image(Image.<span class="bu">open</span>(img_path)))</span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a>    nlp_result <span class="op">=</span> parse_symptoms(symptoms_text)</span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.concatenate([cv_pred[<span class="dv">0</span>], [nlp_result[<span class="st">&quot;urgency&quot;</span>]]])</span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a>    triage_score <span class="op">=</span> rf.predict([features])[<span class="dv">0</span>]  <span class="co"># Placeholder; use trained RF</span></span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a>    urgency <span class="op">=</span> [<span class="st">&quot;low&quot;</span>, <span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>][triage_score]</span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a>    patient_summary <span class="op">=</span> <span class="ss">f&quot;This condition appears to be </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> urgency based on image and symptoms. &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">&quot;Consult a doctor soon.&quot;</span> <span class="cf">if</span> urgency <span class="kw">in</span> [<span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>] <span class="cf">else</span> <span class="st">&quot;Monitor and seek advice if worsening.&quot;</span>)</span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a>    clinician_report <span class="op">=</span> <span class="ss">f&quot;Triage score: </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> (CV: </span><span class="sc">{</span>cv_pred[<span class="dv">0</span>]<span class="sc">.</span>argmax()<span class="sc">}</span><span class="ss">, Symptoms urgency: </span><span class="sc">{</span>nlp_result[<span class="st">&#39;urgency&#39;</span>]<span class="sc">}</span><span class="ss">). &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Urgent review recommended.&quot;</span> <span class="cf">if</span> urgency <span class="op">==</span> <span class="st">&quot;high&quot;</span> <span class="cf">else</span> <span class="st">&quot;Follow-up suggested.&quot;</span>)</span>
<span id="cb99-45"><a href="#cb99-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-46"><a href="#cb99-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_to_db:</span>
<span id="cb99-47"><a href="#cb99-47" aria-hidden="true" tabindex="-1"></a>        cursor.execute(<span class="st">&#39;&#39;&#39;</span></span>
<span id="cb99-48"><a href="#cb99-48" aria-hidden="true" tabindex="-1"></a><span class="st">        INSERT INTO triage_records (image_path, symptoms, cv_class, confidence, triage_score, patient_summary, clinician_report)</span></span>
<span id="cb99-49"><a href="#cb99-49" aria-hidden="true" tabindex="-1"></a><span class="st">        VALUES (?, ?, ?, ?, ?, ?, ?)</span></span>
<span id="cb99-50"><a href="#cb99-50" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;&#39;</span>, (img_path, symptoms_text, urgency, <span class="bu">float</span>(cv_pred[<span class="dv">0</span>].<span class="bu">max</span>()), urgency, patient_summary, clinician_report))</span>
<span id="cb99-51"><a href="#cb99-51" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb99-52"><a href="#cb99-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-53"><a href="#cb99-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patient_summary, clinician_report</span>
<span id="cb99-54"><a href="#cb99-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-55"><a href="#cb99-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Streamlit UI</span></span>
<span id="cb99-56"><a href="#cb99-56" aria-hidden="true" tabindex="-1"></a>st.title(<span class="st">&quot;TriagePal: AI Pre-Analysis Tool&quot;</span>)</span>
<span id="cb99-57"><a href="#cb99-57" aria-hidden="true" tabindex="-1"></a>st.write(<span class="st">&quot;Upload an image and describe symptoms to get a preliminary assessment.&quot;</span>)</span>
<span id="cb99-58"><a href="#cb99-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-59"><a href="#cb99-59" aria-hidden="true" tabindex="-1"></a>uploaded_image <span class="op">=</span> st.file_uploader(<span class="st">&quot;Upload an image (jpg/png)&quot;</span>, <span class="bu">type</span><span class="op">=</span>[<span class="st">&quot;jpg&quot;</span>, <span class="st">&quot;png&quot;</span>])</span>
<span id="cb99-60"><a href="#cb99-60" aria-hidden="true" tabindex="-1"></a>symptoms <span class="op">=</span> st.text_area(<span class="st">&quot;Describe symptoms and conditions (e.g., redness, itch, migraines)&quot;</span>)</span>
<span id="cb99-61"><a href="#cb99-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-62"><a href="#cb99-62" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> st.button(<span class="st">&quot;Analyze&quot;</span>):</span>
<span id="cb99-63"><a href="#cb99-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uploaded_image <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb99-64"><a href="#cb99-64" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> Image.<span class="bu">open</span>(uploaded_image)</span>
<span id="cb99-65"><a href="#cb99-65" aria-hidden="true" tabindex="-1"></a>        st.image(img, caption<span class="op">=</span><span class="st">&quot;Uploaded Image&quot;</span>, width<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb99-66"><a href="#cb99-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-67"><a href="#cb99-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save uploaded image temporarily</span></span>
<span id="cb99-68"><a href="#cb99-68" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="ss">f&quot;/content/</span><span class="sc">{</span>uploaded_image<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb99-69"><a href="#cb99-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(img_path, <span class="st">&quot;wb&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb99-70"><a href="#cb99-70" aria-hidden="true" tabindex="-1"></a>            f.write(uploaded_image.getbuffer())</span>
<span id="cb99-71"><a href="#cb99-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-72"><a href="#cb99-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Analyze</span></span>
<span id="cb99-73"><a href="#cb99-73" aria-hidden="true" tabindex="-1"></a>        patient_summary, clinician_report <span class="op">=</span> process_input(img_path, symptoms)</span>
<span id="cb99-74"><a href="#cb99-74" aria-hidden="true" tabindex="-1"></a>        st.subheader(<span class="st">&quot;Patient Summary&quot;</span>)</span>
<span id="cb99-75"><a href="#cb99-75" aria-hidden="true" tabindex="-1"></a>        st.write(patient_summary)</span>
<span id="cb99-76"><a href="#cb99-76" aria-hidden="true" tabindex="-1"></a>        st.subheader(<span class="st">&quot;Clinician Report&quot;</span>)</span>
<span id="cb99-77"><a href="#cb99-77" aria-hidden="true" tabindex="-1"></a>        st.write(clinician_report)</span>
<span id="cb99-78"><a href="#cb99-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb99-79"><a href="#cb99-79" aria-hidden="true" tabindex="-1"></a>        st.warning(<span class="st">&quot;Please upload an image to proceed.&quot;</span>)</span>
<span id="cb99-80"><a href="#cb99-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-81"><a href="#cb99-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Display recent records</span></span>
<span id="cb99-82"><a href="#cb99-82" aria-hidden="true" tabindex="-1"></a>st.subheader(<span class="st">&quot;Recent Analyses&quot;</span>)</span>
<span id="cb99-83"><a href="#cb99-83" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">&#39;SELECT * FROM triage_records ORDER BY timestamp DESC LIMIT 5&#39;</span>)</span>
<span id="cb99-84"><a href="#cb99-84" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> cursor.fetchall()</span>
<span id="cb99-85"><a href="#cb99-85" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> record <span class="kw">in</span> records:</span>
<span id="cb99-86"><a href="#cb99-86" aria-hidden="true" tabindex="-1"></a>    st.write(<span class="ss">f&quot;**Time:** </span><span class="sc">{</span>record[<span class="dv">3</span>]<span class="sc">}</span><span class="ss">, **Class:** </span><span class="sc">{</span>record[<span class="dv">4</span>]<span class="sc">}</span><span class="ss">, **Triage:** </span><span class="sc">{</span>record[<span class="dv">6</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb99-87"><a href="#cb99-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-88"><a href="#cb99-88" aria-hidden="true" tabindex="-1"></a>st.warning(<span class="st">&quot;This is not a medical diagnosis. Consult a healthcare professional for accurate advice.&quot;</span>)</span>
<span id="cb99-89"><a href="#cb99-89" aria-hidden="true" tabindex="-1"></a>conn.close()  <span class="co"># Close connection on app exit (note: this may not persist in Colab)</span></span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904939,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733797,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="JYSanYeQmrJ4">
<div class="sourceCode" id="cb100"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize the Computer Vision Component</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>datagen <span class="op">=</span> ImageDataGenerator(</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    rescale<span class="op">=</span><span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    rotation_range<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    width_shift_range<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>    height_shift_range<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    horizontal_flip<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    brightness_range<span class="op">=</span>[<span class="fl">0.8</span>, <span class="fl">1.2</span>],</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    validation_split<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>train_generator <span class="op">=</span> datagen.flow_from_dataframe(</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>    train_df, x_col<span class="op">=</span><span class="st">&quot;image_path&quot;</span>, y_col<span class="op">=</span><span class="st">&quot;label&quot;</span>,</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    target_size<span class="op">=</span>(<span class="dv">128</span>, <span class="dv">128</span>), batch_size<span class="op">=</span><span class="dv">32</span>, subset<span class="op">=</span><span class="st">&#39;training&#39;</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>val_generator <span class="op">=</span> datagen.flow_from_dataframe(</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>    val_df, x_col<span class="op">=</span><span class="st">&quot;image_path&quot;</span>, y_col<span class="op">=</span><span class="st">&quot;label&quot;</span>,</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>    target_size<span class="op">=</span>(<span class="dv">128</span>, <span class="dv">128</span>), batch_size<span class="op">=</span><span class="dv">32</span>, subset<span class="op">=</span><span class="st">&#39;validation&#39;</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904939,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733797,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="lcw7SmvRmz5h">
<div class="sourceCode" id="cb101"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Use Keras Tuner to optimize hyperparameters:</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras_tuner <span class="im">import</span> RandomSearch</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, Dropout, GlobalAveragePooling2D, Dense, BatchNormalization</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf <span class="co"># Import tensorflow for callbacks</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_model(hp, num_classes): <span class="co"># Added num_classes as an argument</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential()</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    model.add(Conv2D(hp.Int(<span class="st">&#39;conv1_units&#39;</span>, min_value<span class="op">=</span><span class="dv">32</span>, max_value<span class="op">=</span><span class="dv">128</span>, step<span class="op">=</span><span class="dv">32</span>), (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, input_shape<span class="op">=</span>(<span class="dv">128</span>, <span class="dv">128</span>, <span class="dv">3</span>)))</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    model.add(BatchNormalization())</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    model.add(MaxPooling2D((<span class="dv">2</span>, <span class="dv">2</span>)))</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    model.add(Conv2D(hp.Int(<span class="st">&#39;conv2_units&#39;</span>, min_value<span class="op">=</span><span class="dv">64</span>, max_value<span class="op">=</span><span class="dv">256</span>, step<span class="op">=</span><span class="dv">64</span>), (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    model.add(BatchNormalization())</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>    model.add(MaxPooling2D((<span class="dv">2</span>, <span class="dv">2</span>)))</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    model.add(Conv2D(hp.Int(<span class="st">&#39;conv3_units&#39;</span>, min_value<span class="op">=</span><span class="dv">128</span>, max_value<span class="op">=</span><span class="dv">512</span>, step<span class="op">=</span><span class="dv">128</span>), (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>    model.add(BatchNormalization())</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>    model.add(GlobalAveragePooling2D())</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>    model.add(Dropout(hp.Float(<span class="st">&#39;dropout&#39;</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>, step<span class="op">=</span><span class="fl">0.1</span>)))</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    model.add(Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>)) <span class="co"># Use the passed num_classes</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>,</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>                 loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>, <span class="co"># Keep categorical_crossentropy for softmax output</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>                 metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the number of classes from the generator using class_indices</span></span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>num_classes_for_tuner <span class="op">=</span> <span class="bu">len</span>(train_generator.class_indices)</span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>tuner <span class="op">=</span> RandomSearch(</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> hp: build_model(hp, num_classes<span class="op">=</span>num_classes_for_tuner), <span class="co"># Pass num_classes to the builder</span></span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>    objective<span class="op">=</span><span class="st">&#39;val_accuracy&#39;</span>,</span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>    max_trials<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>    executions_per_trial<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>    directory<span class="op">=</span><span class="st">&#39;tuner_dir_conjunctivitis&#39;</span>, <span class="co"># Changed project name to avoid conflict</span></span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>    project_name<span class="op">=</span><span class="st">&#39;triagepal_cnn_conjunctivitis&#39;</span> <span class="co"># Changed directory name to avoid conflict</span></span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>tuner.search(train_generator,</span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>            epochs<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>            validation_data<span class="op">=</span>val_generator,</span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>            callbacks<span class="op">=</span>[tf.keras.callbacks.EarlyStopping(patience<span class="op">=</span><span class="dv">3</span>)])</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> tuner.get_best_models(num_models<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>best_model.save(<span class="st">&#39;triagepal_optimized_model.h5&#39;</span>)</span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Optimized model saved.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904940,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733798,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="fW7lzMSWnQEq">
<div class="sourceCode" id="cb102"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Enchance NLP</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer, AutoModelForTokenClassification</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(<span class="st">&quot;dmis-lab/biobert-v1.1&quot;</span>)</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForTokenClassification.from_pretrained(<span class="st">&quot;dmis-lab/biobert-v1.1&quot;</span>)</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_symptoms_advanced(text):</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> tokenizer(text, return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span>, padding<span class="op">=</span><span class="va">True</span>, truncation<span class="op">=</span><span class="va">True</span>, max_length<span class="op">=</span><span class="dv">128</span>)</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> model(<span class="op">**</span>inputs)</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> torch.argmax(outputs.logits, dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    tokens <span class="op">=</span> tokenizer.convert_ids_to_tokens(inputs[<span class="st">&quot;input_ids&quot;</span>][<span class="dv">0</span>])</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    symptoms <span class="op">=</span> [tokens[i] <span class="cf">for</span> i, pred <span class="kw">in</span> <span class="bu">enumerate</span>(predictions[<span class="dv">0</span>]) <span class="cf">if</span> pred <span class="op">!=</span> <span class="dv">0</span>]  <span class="co"># Non-0 labels are entities</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    urgency_score <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> sym <span class="kw">in</span> symptoms <span class="cf">if</span> sym.lower() <span class="kw">in</span> [<span class="st">&#39;redness&#39;</span>, <span class="st">&#39;swelling&#39;</span>, <span class="st">&#39;pain&#39;</span>])</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;symptoms&quot;</span>: symptoms, <span class="st">&quot;urgency&quot;</span>: <span class="bu">min</span>(urgency_score, <span class="dv">2</span>)}</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>sample_text <span class="op">=</span> <span class="st">&quot;Patient reports redness and swelling on arm.&quot;</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> parse_symptoms_advanced(sample_text)</span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Extracted symptoms:&quot;</span>, result[<span class="st">&quot;symptoms&quot;</span>])</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Urgency score:&quot;</span>, result[<span class="st">&quot;urgency&quot;</span>])</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904941,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733799,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="C-63ejqjopfl">
<div class="sourceCode" id="cb103"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Improve the Machine Learning Component</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_features(img_path, symptoms_text):</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(img_path).resize((<span class="dv">128</span>, <span class="dv">128</span>))</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.array(img) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.expand_dims(img_array, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    cv_pred <span class="op">=</span> best_model.predict(img_array)  <span class="co"># Use optimized model</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    nlp_result <span class="op">=</span> parse_symptoms_advanced(symptoms_text)</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.concatenate([cv_pred[<span class="dv">0</span>], [nlp_result[<span class="st">&quot;urgency&quot;</span>], <span class="bu">len</span>(nlp_result[<span class="st">&quot;symptoms&quot;</span>])]])</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Example labeled data (replace with actual labels)</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>sample_paths <span class="op">=</span> df_combined[<span class="st">&#39;image_path&#39;</span>].sample(<span class="dv">100</span>).tolist()</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>sample_symptoms <span class="op">=</span> [<span class="st">&quot;redness and swelling&quot;</span> <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">&quot;no symptoms&quot;</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>)]</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.array([extract_features(p, s) <span class="cf">for</span> p, s <span class="kw">in</span> <span class="bu">zip</span>(sample_paths, sample_symptoms)])</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">100</span>)  <span class="co"># Replace with manual labels</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>rf.fit(X_train, y_train)</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> rf.score(X_test, y_test)</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Improved Random Forest Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.2f}</span><span class="ss">&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904940,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733799,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="01mEAblsBnMK">
<div class="sourceCode" id="cb104"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the &#39;rf&#39; variable is the name your teammate used for the trained Random Forest model.</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If they used a different name (e.g., &#39;triage_model&#39;), you must change &#39;rf&#39; below.</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;rf_triage_agent.pkl&#39;</span>, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>        pickle.dump(rf, f)</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;SUCCESS: Triage Agent saved as rf_triage_agent.pkl&quot;</span>)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;You can now download this file and upload it to GitHub.&quot;</span>)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">NameError</span>:</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;ERROR: Could not find the Random Forest variable &#39;rf&#39;. Please check the training cell.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904949,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733808,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="EhOGy-o2pJRi">
<div class="sourceCode" id="cb105"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Integrate with Database and UI</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_input(img_path, symptoms_text, save_to_db<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    cv_pred <span class="op">=</span> best_model.predict(preprocess_image(Image.<span class="bu">open</span>(img_path)))</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    nlp_result <span class="op">=</span> parse_symptoms_advanced(symptoms_text)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.concatenate([cv_pred[<span class="dv">0</span>], [nlp_result[<span class="st">&quot;urgency&quot;</span>], <span class="bu">len</span>(nlp_result[<span class="st">&quot;symptoms&quot;</span>])]])</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    triage_score <span class="op">=</span> rf.predict([features])[<span class="dv">0</span>]</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    urgency <span class="op">=</span> [<span class="st">&quot;low&quot;</span>, <span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>][triage_score]</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    patient_summary <span class="op">=</span> <span class="ss">f&quot;This condition appears to be </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> urgency based on image and </span><span class="sc">{</span><span class="bu">len</span>(nlp_result[<span class="st">&#39;symptoms&#39;</span>])<span class="sc">}</span><span class="ss"> symptoms. &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">&quot;Consult a doctor soon.&quot;</span> <span class="cf">if</span> urgency <span class="kw">in</span> [<span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>] <span class="cf">else</span> <span class="st">&quot;Monitor and seek advice if worsening.&quot;</span>)</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    clinician_report <span class="op">=</span> <span class="ss">f&quot;Triage score: </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> (CV: </span><span class="sc">{</span>cv_pred[<span class="dv">0</span>]<span class="sc">.</span>argmax()<span class="sc">}</span><span class="ss">, Symptoms urgency: </span><span class="sc">{</span>nlp_result[<span class="st">&#39;urgency&#39;</span>]<span class="sc">}</span><span class="ss">, Symptom count: </span><span class="sc">{</span><span class="bu">len</span>(nlp_result[<span class="st">&#39;symptoms&#39;</span>])<span class="sc">}</span><span class="ss">). &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Urgent review recommended.&quot;</span> <span class="cf">if</span> urgency <span class="op">==</span> <span class="st">&quot;high&quot;</span> <span class="cf">else</span> <span class="st">&quot;Follow-up suggested.&quot;</span>)</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_to_db:</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>        cursor.execute(<span class="st">&#39;&#39;&#39;</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a><span class="st">        INSERT INTO triage_records (image_path, symptoms, cv_class, confidence, triage_score, patient_summary, clinician_report)</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a><span class="st">        VALUES (?, ?, ?, ?, ?, ?, ?)</span></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;&#39;</span>, (img_path, symptoms_text, urgency, <span class="bu">float</span>(cv_pred[<span class="dv">0</span>].<span class="bu">max</span>()), urgency, patient_summary, clinician_report))</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patient_summary, clinician_report</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904950,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733809,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="FmK8D-9_pSzq">
<div class="sourceCode" id="cb106"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test and log</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>sample_path <span class="op">=</span> df_combined[<span class="st">&#39;image_path&#39;</span>].dropna().iloc[<span class="dv">0</span>] <span class="co"># Get the first non-NaN image path</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>sample_text <span class="op">=</span> <span class="st">&quot;redness, swelling, and pain&quot;</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>summary, report <span class="op">=</span> process_input(sample_path, sample_text)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Patient Summary:&quot;</span>, summary)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Clinician Report:&quot;</span>, report)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904951,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733810,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="qaa1UUXhproa">
<div class="sourceCode" id="cb107"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Log with MLflow</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run():</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;model&quot;</span>, <span class="st">&quot;optimized_cnn&quot;</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;nlp_model&quot;</span>, <span class="st">&quot;biobert&quot;</span>)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;rf_accuracy&quot;</span>, accuracy)</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;triagepal_optimized_model.h5&quot;</span>)</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Experiment logged.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904951,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733810,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="nnF7YDilrCia">
<div class="sourceCode" id="cb108"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile app.py</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer, AutoModelForTokenClassification</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Database connection</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">&#39;triagepal.db&#39;</span>)</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the model architecture as it was when `triagepal_optimized_model.h5` was saved</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a><span class="co"># This function rebuilds the model, allowing us to load weights instead of the full model config.</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D, Dropout, GlobalAveragePooling2D, Dense, BatchNormalization</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_model_for_loading(conv1_units, conv2_units, conv3_units, dropout_rate, num_classes):</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Sequential()</span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>    model.add(Conv2D(conv1_units, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>, input_shape<span class="op">=</span>(<span class="dv">128</span>, <span class="dv">128</span>, <span class="dv">3</span>)))</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>    model.add(BatchNormalization())</span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>    model.add(MaxPooling2D((<span class="dv">2</span>, <span class="dv">2</span>)))</span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    model.add(Conv2D(conv2_units, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>    model.add(BatchNormalization())</span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>    model.add(MaxPooling2D((<span class="dv">2</span>, <span class="dv">2</span>)))</span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>    model.add(Conv2D(conv3_units, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))</span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>    model.add(BatchNormalization())</span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>    model.add(GlobalAveragePooling2D())</span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>    model.add(Dropout(dropout_rate))</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>    model.add(Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>))</span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adam&#39;</span>, loss<span class="op">=</span><span class="st">&#39;categorical_crossentropy&#39;</span>, metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Assumed (or known) hyperparameters and number of classes for the conjunctivitis model</span></span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a><span class="co"># These values are based on the structure defined in cell lcw7SmvRmz5h and the binary classification nature.</span></span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>NUM_CLASSES_CONJUNCTIVITIS <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>OPT_CONV1_UNITS <span class="op">=</span> <span class="dv">32</span> <span class="co"># min_value from tuner search</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>OPT_CONV2_UNITS <span class="op">=</span> <span class="dv">256</span> <span class="co"># Corrected based on shape mismatch error</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>OPT_CONV3_UNITS <span class="op">=</span> <span class="dv">384</span> <span class="co"># Corrected based on latest shape mismatch error</span></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>OPT_DROPOUT_RATE <span class="op">=</span> <span class="fl">0.3</span> <span class="co"># A common tuned value, or assume default from range</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the model architecture</span></span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> build_model_for_loading(OPT_CONV1_UNITS, OPT_CONV2_UNITS, OPT_CONV3_UNITS, OPT_DROPOUT_RATE, NUM_CLASSES_CONJUNCTIVITIS)</span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the saved weights into the reconstructed model</span></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>model.load_weights(<span class="st">&#39;/content/triagepal_optimized_model.h5&#39;</span>)</span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Load trained RandomForestClassifier</span></span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;/content/rf_triage_agent.pkl&#39;</span>, <span class="st">&#39;rb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a>        rf <span class="op">=</span> pickle.load(f)</span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">FileNotFoundError</span>:</span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a>    st.error(<span class="st">&quot;Error: Trained Random Forest model not found. Please ensure &#39;rf_triage_agent.pkl&#39; is in /content/.&quot;</span>)</span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a>    st.stop() <span class="co"># Stop the app if the model isn&#39;t found</span></span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocess image</span></span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image):</span>
<span id="cb108-62"><a href="#cb108-62" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> image.resize((<span class="dv">128</span>, <span class="dv">128</span>))</span>
<span id="cb108-63"><a href="#cb108-63" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.array(img) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb108-64"><a href="#cb108-64" aria-hidden="true" tabindex="-1"></a>    img_array <span class="op">=</span> np.expand_dims(img_array, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb108-65"><a href="#cb108-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_array</span>
<span id="cb108-66"><a href="#cb108-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-67"><a href="#cb108-67" aria-hidden="true" tabindex="-1"></a><span class="co"># NLP with BioBERT</span></span>
<span id="cb108-68"><a href="#cb108-68" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(<span class="st">&quot;dmis-lab/biobert-v1.1&quot;</span>)</span>
<span id="cb108-69"><a href="#cb108-69" aria-hidden="true" tabindex="-1"></a>model_nlp <span class="op">=</span> AutoModelForTokenClassification.from_pretrained(<span class="st">&quot;dmis-lab/biobert-v1.1&quot;</span>)</span>
<span id="cb108-70"><a href="#cb108-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-71"><a href="#cb108-71" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_symptoms_advanced(text):</span>
<span id="cb108-72"><a href="#cb108-72" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> tokenizer(text, return_tensors<span class="op">=</span><span class="st">&quot;pt&quot;</span>, padding<span class="op">=</span><span class="va">True</span>, truncation<span class="op">=</span><span class="va">True</span>, max_length<span class="op">=</span><span class="dv">128</span>)</span>
<span id="cb108-73"><a href="#cb108-73" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> model_nlp(<span class="op">**</span>inputs)</span>
<span id="cb108-74"><a href="#cb108-74" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> torch.argmax(outputs.logits, dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb108-75"><a href="#cb108-75" aria-hidden="true" tabindex="-1"></a>    tokens <span class="op">=</span> tokenizer.convert_ids_to_tokens(inputs[<span class="st">&quot;input_ids&quot;</span>][<span class="dv">0</span>])</span>
<span id="cb108-76"><a href="#cb108-76" aria-hidden="true" tabindex="-1"></a>    symptoms <span class="op">=</span> [tokens[i] <span class="cf">for</span> i, pred <span class="kw">in</span> <span class="bu">enumerate</span>(predictions[<span class="dv">0</span>]) <span class="cf">if</span> pred <span class="op">!=</span> <span class="dv">0</span>] <span class="co"># Non-0 labels are entities</span></span>
<span id="cb108-77"><a href="#cb108-77" aria-hidden="true" tabindex="-1"></a>    urgency_score <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> sym <span class="kw">in</span> symptoms <span class="cf">if</span> sym.lower() <span class="kw">in</span> [<span class="st">&#39;redness&#39;</span>, <span class="st">&#39;swelling&#39;</span>, <span class="st">&#39;pain&#39;</span>])</span>
<span id="cb108-78"><a href="#cb108-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&quot;symptoms&quot;</span>: symptoms, <span class="st">&quot;urgency&quot;</span>: <span class="bu">min</span>(urgency_score, <span class="dv">2</span>)}</span>
<span id="cb108-79"><a href="#cb108-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-80"><a href="#cb108-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Process input</span></span>
<span id="cb108-81"><a href="#cb108-81" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_input(img_path, symptoms_text, save_to_db<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb108-82"><a href="#cb108-82" aria-hidden="true" tabindex="-1"></a>    cv_pred <span class="op">=</span> model.predict(preprocess_image(Image.<span class="bu">open</span>(img_path)))</span>
<span id="cb108-83"><a href="#cb108-83" aria-hidden="true" tabindex="-1"></a>    nlp_result <span class="op">=</span> parse_symptoms_advanced(symptoms_text)</span>
<span id="cb108-84"><a href="#cb108-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure features array has correct dimensions for rf.predict</span></span>
<span id="cb108-85"><a href="#cb108-85" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> np.concatenate([cv_pred[<span class="dv">0</span>], [nlp_result[<span class="st">&quot;urgency&quot;</span>], <span class="bu">len</span>(nlp_result[<span class="st">&quot;symptoms&quot;</span>])]])</span>
<span id="cb108-86"><a href="#cb108-86" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> features.reshape(<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>) <span class="co"># Reshape for single sample prediction</span></span>
<span id="cb108-87"><a href="#cb108-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-88"><a href="#cb108-88" aria-hidden="true" tabindex="-1"></a>    triage_score <span class="op">=</span> rf.predict(features)[<span class="dv">0</span>]</span>
<span id="cb108-89"><a href="#cb108-89" aria-hidden="true" tabindex="-1"></a>    urgency <span class="op">=</span> [<span class="st">&quot;low&quot;</span>, <span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>][<span class="bu">int</span>(triage_score)] <span class="co"># Ensure triage_score is integer for indexing</span></span>
<span id="cb108-90"><a href="#cb108-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-91"><a href="#cb108-91" aria-hidden="true" tabindex="-1"></a>    patient_summary <span class="op">=</span> <span class="ss">f&quot;This condition appears to be </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> urgency based on image and </span><span class="sc">{</span><span class="bu">len</span>(nlp_result[<span class="st">&#39;symptoms&#39;</span>])<span class="sc">}</span><span class="ss"> symptoms. &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb108-92"><a href="#cb108-92" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">&quot;Consult a doctor soon.&quot;</span> <span class="cf">if</span> urgency <span class="kw">in</span> [<span class="st">&quot;medium&quot;</span>, <span class="st">&quot;high&quot;</span>] <span class="cf">else</span> <span class="st">&quot;Monitor and seek advice if worsening.&quot;</span>)</span>
<span id="cb108-93"><a href="#cb108-93" aria-hidden="true" tabindex="-1"></a>    clinician_report <span class="op">=</span> <span class="ss">f&quot;Triage score: </span><span class="sc">{</span>urgency<span class="sc">}</span><span class="ss"> (CV: </span><span class="sc">{</span>cv_pred[<span class="dv">0</span>]<span class="sc">.</span>argmax()<span class="sc">}</span><span class="ss">, Symptoms urgency: </span><span class="sc">{</span>nlp_result[<span class="st">&#39;urgency&#39;</span>]<span class="sc">}</span><span class="ss">, Symptom count: </span><span class="sc">{</span><span class="bu">len</span>(nlp_result[<span class="st">&#39;symptoms&#39;</span>])<span class="sc">}</span><span class="ss">). &quot;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb108-94"><a href="#cb108-94" aria-hidden="true" tabindex="-1"></a>                      (<span class="st">&quot;Urgent review recommended.&quot;</span> <span class="cf">if</span> urgency <span class="op">==</span> <span class="st">&quot;high&quot;</span> <span class="cf">else</span> <span class="st">&quot;Follow-up suggested.&quot;</span>)</span>
<span id="cb108-95"><a href="#cb108-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-96"><a href="#cb108-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save_to_db:</span>
<span id="cb108-97"><a href="#cb108-97" aria-hidden="true" tabindex="-1"></a>        cursor.execute(<span class="st">&#39;&#39;&#39;</span></span>
<span id="cb108-98"><a href="#cb108-98" aria-hidden="true" tabindex="-1"></a><span class="st">        INSERT INTO triage_records (image_path, symptoms, cv_class, confidence, triage_score, patient_summary, clinician_report)</span></span>
<span id="cb108-99"><a href="#cb108-99" aria-hidden="true" tabindex="-1"></a><span class="st">        VALUES (?, ?, ?, ?, ?, ?, ?)</span></span>
<span id="cb108-100"><a href="#cb108-100" aria-hidden="true" tabindex="-1"></a><span class="st">        &#39;&#39;&#39;</span>, (img_path, symptoms_text, urgency, <span class="bu">float</span>(cv_pred[<span class="dv">0</span>].<span class="bu">max</span>()), urgency, patient_summary, clinician_report))</span>
<span id="cb108-101"><a href="#cb108-101" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb108-102"><a href="#cb108-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-103"><a href="#cb108-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> patient_summary, clinician_report</span>
<span id="cb108-104"><a href="#cb108-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-105"><a href="#cb108-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Streamlit UI</span></span>
<span id="cb108-106"><a href="#cb108-106" aria-hidden="true" tabindex="-1"></a>st.title(<span class="st">&quot;TriagePal: AI Pre-Analysis Tool&quot;</span>)</span>
<span id="cb108-107"><a href="#cb108-107" aria-hidden="true" tabindex="-1"></a>st.write(<span class="st">&quot;Upload an image and describe symptoms to get a preliminary assessment.&quot;</span>)</span>
<span id="cb108-108"><a href="#cb108-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-109"><a href="#cb108-109" aria-hidden="true" tabindex="-1"></a>uploaded_image <span class="op">=</span> st.file_uploader(<span class="st">&quot;Upload an image (jpg/png)&quot;</span>, <span class="bu">type</span><span class="op">=</span>[<span class="st">&quot;jpg&quot;</span>, <span class="st">&quot;png&quot;</span>])</span>
<span id="cb108-110"><a href="#cb108-110" aria-hidden="true" tabindex="-1"></a>symptoms <span class="op">=</span> st.text_area(<span class="st">&quot;Describe symptoms and conditions (e.g., redness, itch, migraines)&quot;</span>)</span>
<span id="cb108-111"><a href="#cb108-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-112"><a href="#cb108-112" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> st.button(<span class="st">&quot;Analyze&quot;</span>):</span>
<span id="cb108-113"><a href="#cb108-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uploaded_image <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb108-114"><a href="#cb108-114" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> Image.<span class="bu">open</span>(uploaded_image)</span>
<span id="cb108-115"><a href="#cb108-115" aria-hidden="true" tabindex="-1"></a>        st.image(img, caption<span class="op">=</span><span class="st">&quot;Uploaded Image&quot;</span>, width<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb108-116"><a href="#cb108-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-117"><a href="#cb108-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save uploaded image temporarily</span></span>
<span id="cb108-118"><a href="#cb108-118" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> <span class="ss">f&quot;/content/</span><span class="sc">{</span>uploaded_image<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb108-119"><a href="#cb108-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(img_path, <span class="st">&quot;wb&quot;</span>) <span class="im">as</span> f:</span>
<span id="cb108-120"><a href="#cb108-120" aria-hidden="true" tabindex="-1"></a>            f.write(uploaded_image.getbuffer())</span>
<span id="cb108-121"><a href="#cb108-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-122"><a href="#cb108-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Analyze</span></span>
<span id="cb108-123"><a href="#cb108-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb108-124"><a href="#cb108-124" aria-hidden="true" tabindex="-1"></a>            patient_summary, clinician_report <span class="op">=</span> process_input(img_path, symptoms)</span>
<span id="cb108-125"><a href="#cb108-125" aria-hidden="true" tabindex="-1"></a>            st.subheader(<span class="st">&quot;Patient Summary&quot;</span>)</span>
<span id="cb108-126"><a href="#cb108-126" aria-hidden="true" tabindex="-1"></a>            st.write(patient_summary)</span>
<span id="cb108-127"><a href="#cb108-127" aria-hidden="true" tabindex="-1"></a>            st.subheader(<span class="st">&quot;Clinician Report&quot;</span>)</span>
<span id="cb108-128"><a href="#cb108-128" aria-hidden="true" tabindex="-1"></a>            st.write(clinician_report)</span>
<span id="cb108-129"><a href="#cb108-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb108-130"><a href="#cb108-130" aria-hidden="true" tabindex="-1"></a>            st.error(<span class="ss">f&quot;Error during analysis: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb108-131"><a href="#cb108-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb108-132"><a href="#cb108-132" aria-hidden="true" tabindex="-1"></a>        st.warning(<span class="st">&quot;Please upload an image to proceed.&quot;</span>)</span>
<span id="cb108-133"><a href="#cb108-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-134"><a href="#cb108-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Display recent records</span></span>
<span id="cb108-135"><a href="#cb108-135" aria-hidden="true" tabindex="-1"></a>st.subheader(<span class="st">&quot;Recent Analyses&quot;</span>)</span>
<span id="cb108-136"><a href="#cb108-136" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">&#39;SELECT * FROM triage_records ORDER BY timestamp DESC LIMIT 5&#39;</span>)</span>
<span id="cb108-137"><a href="#cb108-137" aria-hidden="true" tabindex="-1"></a>records <span class="op">=</span> cursor.fetchall()</span>
<span id="cb108-138"><a href="#cb108-138" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> record <span class="kw">in</span> records:</span>
<span id="cb108-139"><a href="#cb108-139" aria-hidden="true" tabindex="-1"></a>    st.write(<span class="ss">f&quot;**Time:** </span><span class="sc">{</span>record[<span class="dv">3</span>]<span class="sc">}</span><span class="ss">, **Class:** </span><span class="sc">{</span>record[<span class="dv">4</span>]<span class="sc">}</span><span class="ss">, **Triage:** </span><span class="sc">{</span>record[<span class="dv">6</span>]<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb108-140"><a href="#cb108-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-141"><a href="#cb108-141" aria-hidden="true" tabindex="-1"></a>st.warning(<span class="st">&quot;This is not a medical diagnosis. Consult a healthcare professional for accurate advice.&quot;</span>)</span>
<span id="cb108-142"><a href="#cb108-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Removed conn.close() from here, as it might prematurely close the connection</span></span>
<span id="cb108-143"><a href="#cb108-143" aria-hidden="true" tabindex="-1"></a><span class="co"># for subsequent operations. It&#39;s better to manage connection lifecycle in a web app context.</span></span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904951,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733811,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="eTp0DRF2rW9P">
<div class="sourceCode" id="cb109"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual test outside UI</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>sample_path <span class="op">=</span> df_combined[<span class="st">&#39;image_path&#39;</span>].dropna().iloc[<span class="dv">0</span>]</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>sample_text <span class="op">=</span> <span class="st">&quot;redness and swelling&quot;</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>summary, report <span class="op">=</span> process_input(sample_path, sample_text)</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Summary:&quot;</span>, summary)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Report:&quot;</span>, report)</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">&#39;SELECT * FROM triage_records ORDER BY id DESC LIMIT 1&#39;</span>)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Last record:&quot;</span>, cursor.fetchone())</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904951,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733811,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="SOSJVWcUrdVS">
<div class="sourceCode" id="cb110"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Log and text MlFlow</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run():</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">&quot;integration_step&quot;</span>, <span class="st">&quot;step_8&quot;</span>)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">&quot;test_cases_run&quot;</span>, <span class="dv">4</span>)  <span class="co"># Update based on tests</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">&quot;triagepal.db&quot;</span>)</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Test results logged.&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904952,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733812,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="X6zw_U1FsLqK">
<div class="sourceCode" id="cb111"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Package Application</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile requirements.txt</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>streamlit</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>tensorflow</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>transformers</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>torch</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>numpy</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>pandas</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>scikit<span class="op">-</span>learn</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>pillow</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>pyngrok</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>sqlite3</span></code></pre></div>
</div>
<div class="cell code"
data-executionInfo="{&quot;elapsed&quot;:904952,&quot;status&quot;:&quot;aborted&quot;,&quot;timestamp&quot;:1763511733812,&quot;user&quot;:{&quot;displayName&quot;:&quot;Jazmine&quot;,&quot;userId&quot;:&quot;04718938192117862694&quot;},&quot;user_tz&quot;:360}"
id="wkls-NzospfU">
<div class="sourceCode" id="cb112"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Test deployment</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyngrok <span class="im">import</span> ngrok</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Kill existing processes</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">&quot;pkill ngrok&quot;</span>)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">&quot;pkill -f streamlit&quot;</span>)</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Set authtoken</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>ngrok.set_auth_token(<span class="st">&quot;34kPpTGbA8SPniLPhSFXRl3VjEE_4pT93d7LLqCaiq4j8Ub9m&quot;</span>)</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Start Streamlit</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>streamlit run <span class="op">/</span>content<span class="op">/</span>app.py <span class="op">&amp;&gt;/</span>content<span class="op">/</span>logs.txt <span class="op">&amp;</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait and connect tunnel</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>time.sleep(<span class="dv">5</span>)</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>public_url <span class="op">=</span> ngrok.<span class="ex">connect</span>(addr<span class="op">=</span><span class="st">&quot;localhost:8501&quot;</span>)</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Local app running at:&quot;</span>, public_url)</span></code></pre></div>
</div>
</body>
</html>
